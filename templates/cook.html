{% extends "base.html" %}
{% block title %}–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–≤–∞—Ä–∞{% endblock %}
{% block header_title %}üë®‚Äçüç≥ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–≤–∞—Ä–∞{% endblock %}
{% block extra_css %}
<style>
/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
.admin-layout {
display: flex;
gap: 30px;
margin-bottom: 20px;
}

.sidebar-menu {
width: 250px;
background: white;
border-radius: 12px;
padding: 20px;
box-shadow: 0 2px 10px rgba(0,0,0,0.08);
border: 1px solid #e9ecef;
flex-shrink: 0;
}

.menu-item {
display: flex;
align-items: center;
gap: 12px;
padding: 12px 16px;
border-radius: 8px;
cursor: pointer;
transition: all 0.3s;
margin-bottom: 8px;
font-weight: 500;
color: #495057;
border-left: 3px solid transparent;
}

.menu-item:hover {
background: #f8f9ff;
color: #4361ee;
}

.menu-item.active {
background: #e8f4ff;
color: #4361ee;
border-left-color: #4361ee;
box-shadow: 0 2px 8px rgba(67, 97, 238, 0.1);
}

.menu-item i {
font-size: 1.2rem;
min-width: 24px;
text-align: center;
}

/* –ö–æ–Ω—Ç–µ–Ω—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å */
.content-area {
flex: 1;
background: white;
border-radius: 12px;
padding: 24px;
box-shadow: 0 2px 10px rgba(0,0,0,0.08);
border: 1px solid #e9ecef;
}

.content-section {
display: none;
}

.content-section.active {
display: block;
animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

/* –õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
.personal-info-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 16px;
margin-top: 16px;
}

.info-item {
background: #f8f9ff;
padding: 12px;
border-radius: 8px;
border-left: 3px solid #4361ee;
}

.info-label {
font-size: 0.85rem;
color: #6c757d;
margin-bottom: 4px;
}

.info-value {
font-weight: 600;
color: #2b2d42;
}

/* –ê–≤–∞—Ç–∞—Ä–∫–∞ */
.avatar-container {
text-align: center;
margin-bottom: 30px;
}

.avatar-img {
width: 120px;
height: 120px;
border-radius: 50%;
object-fit: cover;
border: 4px solid #4361ee;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.avatar-edit-btn {
position: absolute;
bottom: 0;
right: 0;
background: #4361ee;
color: white;
width: 36px;
height: 36px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stat-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 16px;
margin-top: 16px;
}

.stat-card {
background: #f0f4ff;
padding: 16px;
border-radius: 8px;
text-align: center;
border-left: 4px solid #4361ee;
}

.stat-value {
font-size: 1.8rem;
font-weight: bold;
color: #2b2d42;
margin: 8px 0;
}

.stat-label {
font-size: 0.9rem;
color: #6c757d;
}

/* Flash-—Å–æ–æ–±—â–µ–Ω–∏—è */
.flash-message {
padding: 12px;
margin-bottom: 20px;
border-radius: 8px;
font-weight: bold;
color: white;
}

.flash-success {
background: #2ecc71;
}

.flash-error {
background: #e74c3c;
}

.flash-info {
background: #3498db;
}

.flash-warning {
background: #f39c12;
}

/* –¢–∞–±–ª–∏—Ü—ã */
.table-responsive {
overflow-x: auto;
margin-top: 16px;
}

table {
width: 100%;
border-collapse: collapse;
margin-top: 12px;
}

th {
background: #f0f0ff;
padding: 12px;
text-align: left;
font-weight: 600;
color: #2b2d42;
}

td {
padding: 12px;
border-bottom: 1px solid #eee;
}

tr:hover {
background: #f8f9ff;
}

/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
.btn-action {
padding: 6px 12px;
border: none;
border-radius: 4px;
cursor: pointer;
font-weight: 600;
transition: all 0.2s;
}

.btn-success {
background: #2ecc71;
color: white;
}

.btn-danger {
background: #e74c3c;
color: white;
}

.btn-warning {
background: #f39c12;
color: white;
}

.btn-info {
background: #3498db;
color: white;
}

.btn-action:hover {
opacity: 0.9;
transform: translateY(-1px);
}

/* –§–æ—Ä–º—ã */
.form-group {
margin-bottom: 16px;
}

.form-group label {
display: block;
margin-bottom: 6px;
font-weight: 500;
color: #495057;
}

.form-control {
width: 100%;
padding: 10px 12px;
border: 1px solid #ddd;
border-radius: 6px;
font-size: 1rem;
}

.btn-submit {
background: #4361ee;
color: white;
border: none;
padding: 12px 24px;
border-radius: 8px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}

.btn-submit:hover {
background: #3a56e4;
transform: translateY(-2px);
}

/* –ü–æ–∏—Å–∫ */
#search-students {
width: 100%;
padding: 10px 12px;
margin-bottom: 16px;
border: 1px solid #ddd;
border-radius: 6px;
font-size: 1rem;
}

/* ============================================
–°–¢–ò–õ–ò –ò–ó –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ì–û –ö–ê–ë–ò–ù–ï–¢–ê –ü–û–í–ê–†–ê
============================================ */

/* –°–∫—Ä–æ–ª–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.scroll-container {
max-height: 300px;
overflow-y: auto;
padding: 8px;
border: 1px solid #eee;
border-radius: 10px;
background: #fafafa;
margin-bottom: 24px;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ–Ω–∏–∫–∞ */
.student-card {
background: white;
border: 1px solid #e0e0ff;
border-radius: 8px;
padding: 12px;
margin-bottom: 12px;
font-size: 0.92rem;
display: block;
}

.student-header {
font-weight: bold;
color: #2b2d42;
margin-bottom: 6px;
display: flex;
justify-content: space-between;
}

.allergy-badge {
background: #ffebee;
color: #c62828;
padding: 2px 6px;
border-radius: 4px;
font-size: 0.85rem;
}

.section-title {
font-size: 0.95rem;
margin: 8px 0 4px;
color: #4361ee;
font-weight: 600;
}

.meal-item {
display: flex;
justify-content: space-between;
padding: 4px 0;
font-size: 0.9rem;
align-items: center;
}

.meal-type { color: #2b2d42; }
.meal-date { color: #666; font-size: 0.85rem; }

.review-box {
background: #e8f5e9;
padding: 4px 6px;
border-radius: 4px;
margin-top: 4px;
font-style: italic;
font-size: 0.85rem;
color: #2e7d32;
}

.no-data { color: #888; font-style: italic; font-size: 0.9rem; }

.mark-btn {
background: #4361ee;
color: white;
border: none;
border-radius: 4px;
padding: 2px 6px;
font-size: 0.8rem;
cursor: pointer;
margin-left: 6px;
}

.mark-btn:hover {
background: #3a56e4;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–µ–∫—Ü–∏–∏ */
.card {
background: white;
border-radius: 12px;
padding: 20px;
margin-bottom: 24px;
box-shadow: 0 2px 10px rgba(0,0,0,0.08);
border: 1px solid #e9ecef;
}

.card h2 {
margin-top: 0;
color: #2c3e50;
font-size: 1.3rem;
}

/* –ö–æ—Ä–∑–∏–Ω–∞ –∑–∞–∫—É–ø–æ–∫ */
#cart-items {
min-height: 60px;
margin-bottom: 12px;
}

#cart-empty {
color: #888;
text-align: center;
padding: 20px;
}

#cart-list {
list-style: none;
padding: 0;
margin: 0;
}

#cart-list li {
padding: 8px 0;
border-bottom: 1px solid #eee;
}

.edit-qty {
width: 80px;
padding: 4px;
border: 1px solid #ddd;
border-radius: 4px;
}

.remove-item {
color: #e74c3c;
background: none;
border: none;
cursor: pointer;
padding: 0;
margin-left: 8px;
}

/* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É */
#add-to-cart-form {
display: flex;
gap: 10px;
flex-wrap: wrap;
}

#product-select, #quantity-input {
padding: 8px;
border: 1px solid #ddd;
border-radius: 6px;
}

#product-select {
flex: 2;
}

#quantity-input {
flex: 1;
}
</style>
{% endblock %}
{% block content %}
<!-- üì¢ FLASH-–°–û–û–ë–©–ï–ù–ò–Ø -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="flash-message flash-{{ category if category in ['success', 'error'] else 'info' }}">
{{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="admin-layout">
    <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
    <div class="sidebar-menu">
        <div class="menu-item active" data-section="personal-info">
            <span>üë§</span>
            <span>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
        </div>
        <div class="menu-item" data-section="stock-management">
            <span>üì¶</span>
            <span>–û—Å—Ç–∞—Ç–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</span>
        </div>
        <div class="menu-item" data-section="purchase-cart">
            <span>üõí</span>
            <span>–ö–æ—Ä–∑–∏–Ω–∞ –∑–∞–∫—É–ø–æ–∫</span>
        </div>
        <div class="menu-item" data-section="write-off">
            <span>üóëÔ∏è</span>
            <span>–°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</span>
        </div>
        <div class="menu-item" data-section="write-off-log">
            <span>üìã</span>
            <span>–ñ—É—Ä–Ω–∞–ª —Å–ø–∏—Å–∞–Ω–∏–π</span>
        </div>
        <div class="menu-item" data-section="students-list">
            <span>üë•</span>
            <span>–°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤</span>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
    <div class="content-area">
        <!-- –õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div id="personal-info" class="content-section active">
            <h2>üë§ –õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>

            <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ -->
            <div class="avatar-container">
                <div style="position: relative; display: inline-block;">
                    <img
                        src="{{ url_for('static', filename='avatars/' + current_user.avatar_filename) }}"
                        alt="–ê–≤–∞—Ç–∞—Ä–∫–∞"
                        class="avatar-img"
                        id="avatar-preview"
                    >
                    <label for="avatar-input" class="avatar-edit-btn" style="cursor: pointer;">
                        ‚úèÔ∏è
                        <input type="file" id="avatar-input" name="avatar" accept="image/*" style="display: none;">
                    </label>
                </div>
                <p style="margin-top: 12px; color: #6c757d; font-size: 0.9rem;">
                    –ù–∞–∂–º–∏—Ç–µ –Ω–∞ ‚úèÔ∏è —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É
                </p>

                <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–∫—Ä—ã—Ç–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS) -->
                <form id="avatar-upload-form" method="post" action="/upload_avatar" enctype="multipart/form-data" style="display: none;">
                    <input type="file" name="avatar" id="avatar-file-input" accept="image/*">
                </form>
            </div>

            <div class="personal-info-grid">
                <div class="info-item">
                    <div class="info-label">–§–ò–û</div>
                    <div class="info-value">{{ current_user.full_name }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ current_user.email }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                    <div class="info-value">
                        {% if current_user.timestamp %}
                            {{ current_user.timestamp.strftime('%d.%m.%Y %H:%M') }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- –û—Å—Ç–∞—Ç–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ - –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ò–õ–¨ -->
        <div id="stock-management" class="content-section">
            <div class="card">
                <h2>üì¶ –û—Å—Ç–∞—Ç–∫–∏ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å (–¥–ª—è {{ total_students }} —É—á–µ–Ω–∏–∫–∞(–æ–≤))</h2>
                {% if need_and_stock %}
                    <div class="scroll-container" style="max-height: 250px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f0f0ff;">
                                    <th style="padding: 8px; text-align: left;">–ü—Ä–æ–¥—É–∫—Ç</th>
                                    <th style="padding: 8px; text-align: right;">–ù—É–∂–Ω–æ</th>
                                    <th style="padding: 8px; text-align: right;">–ï—Å—Ç—å</th>
                                    <th style="padding: 8px; text-align: right;">–î–µ—Ñ–∏—Ü–∏—Ç</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in need_and_stock %}
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">{{ item.name }}</td>
                                    <td style="padding: 8px; text-align: right;">{{ "%.1f"|format(item.needed) }} {{ item.unit }}</td>
                                    <td style="padding: 8px; text-align: right; color: {% if item.current >= item.needed %}#2ecc71{% else %}#e74c3c{% endif %};">
                                        {{ "%.1f"|format(item.current) }} {{ item.unit }}
                                    </td>
                                    <td style="padding: 8px; text-align: right; color: #e74c3c; font-weight: bold;">
                                        {% if item.deficit > 0 %}{{ "%.1f"|format(item.deficit) }} {{ item.unit }}{% else %}‚Äî{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="no-orders" style="color: #888; text-align: center; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö –∏–ª–∏ —É—á–µ–Ω–∏–∫–∞—Ö.</p>
                {% endif %}
            </div>
        </div>

        <!-- –ö–æ—Ä–∑–∏–Ω–∞ –∑–∞–∫—É–ø–æ–∫ - –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ò–õ–¨ -->
        <div id="purchase-cart" class="content-section">
            <div class="card">
                <h2>üõí –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É</h2>
                <form id="add-to-cart-form">
                    <select id="product-select" required style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>
                        {% for ing in all_ingredients %}
                            <option value="{{ ing.name }}" data-unit="{{ ing.default_unit }}">{{ ing.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="number" id="quantity-input" min="1" step="1" value="1"
                        style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;" required>
                    <button type="submit" class="btn-submit" style="width: auto; padding: 8px 12px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                </form>
            </div>

            <div class="card">
                <h2>üì¶ –ö–æ—Ä–∑–∏–Ω–∞ –∑–∞–∫—É–ø–æ–∫</h2>
                <div id="cart-items">
                    <p id="cart-empty" style="color: #888;">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.</p>
                    <ul id="cart-list" style="list-style: none; padding: 0; margin: 0;"></ul>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 10px;">
                    <button id="send-cart" class="btn-submit" style="flex: 1;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—É</button>
                    <button id="clear-cart" class="btn-submit" style="flex: 1; background: #e74c3c;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
        <div id="write-off" class="content-section">
            <div class="card">
                <h2>üóëÔ∏è –°–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç (–ø–æ—Ä—á–∞, –æ—à–∏–±–∫–∞)</h2>
                <form method="post" action="/cook/write_off">
                    <div class="form-group">
                        <label>–ü—Ä–æ–¥—É–∫—Ç</label>
                        <select name="ingredient_id" class="form-control" required>
                            {% for ing in all_ingredients %}
                                <option value="{{ ing.id }}">{{ ing.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        <input type="number" name="quantity" min="0.1" step="0.1"
                            class="form-control" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" required>
                    </div>

                    <div class="form-group">
                        <label>–ü—Ä–∏—á–∏–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="text" name="reason" class="form-control"
                            placeholder="–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è">
                    </div>

                    <button type="submit" class="btn-submit" style="width: 100%;">
                        –°–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç
                    </button>
                </form>
            </div>
        </div>

        <!-- –ñ—É—Ä–Ω–∞–ª —Å–ø–∏—Å–∞–Ω–∏–π -->
        <div id="write-off-log" class="content-section">
            <div class="card">
                <h2>üìã –ñ—É—Ä–Ω–∞–ª —Å–ø–∏—Å–∞–Ω–∏–π</h2>
                {% if write_offs %}
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                                    <th>–î–∞—Ç–∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for w in write_offs %}
                                <tr>
                                    <td>{{ w.ingredient.name }}</td>
                                    <td>{{ "%.1f"|format(w.quantity) }} {{ w.unit }}</td>
                                    <td>{{ w.reason if w.reason else '‚Äî' }}</td>
                                    <td>{{ w.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p style="text-align: center; color: #6c757d; padding: 20px;">
                        –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —Å–ø–∏—Å–∞–Ω–∏—è—Ö
                    </p>
                {% endif %}
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤ - –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ò–õ–¨ -->
        <div id="students-list" class="content-section">
            <div class="card">
                <h2>üë• –°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤</h2>
                <input type="text" id="search-students" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û...">
                <div class="scroll-container" id="students-list-container">
                    {% if students %}
                        {% for item in students %}
                        <div class="student-card" data-name="{{ item.student.full_name|lower }}">
                            <div class="student-header">
                                <span>{{ item.student.full_name }}</span>
                                {% if item.allergy %}
                                    <span class="allergy-badge">‚ö†Ô∏è {{ item.allergy[:20] }}{% if item.allergy|length > 20 %}...{% endif %}</span>
                                {% endif %}
                            </div>

                            <div class="section-title">üïó –û–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏</div>
                            {% if item.pending %}
                                {% for order_entry in item.pending %}
                                <div class="meal-item">
                                    <span class="meal-type">{{ "–ó–∞–≤—Ç—Ä–∞–∫" if order_entry.order.meal_type == "breakfast" else "–û–±–µ–¥" }}</span>
                                    <span>
                                        <span class="meal-date">{{ order_entry.order.serving_date.strftime('%d.%m') }}</span>
                                        <form method="post" action="/cook/mark_collected" style="display: inline;">
                                            <input type="hidden" name="order_id" value="{{ order_entry.order.id }}">
                                            <button type="submit" class="mark-btn">–í—ã–¥–∞–Ω–æ</button>
                                        </form>
                                    </span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="no-data">‚Äî</p>
                            {% endif %}

                            <div class="section-title">‚úÖ –ü–æ–ª—É—á–µ–Ω–æ</div>
                            {% if item.completed %}
                                {% for order_entry in item.completed %}
                                <div class="meal-item">
                                    <span class="meal-type">{{ "–ó–∞–≤—Ç—Ä–∞–∫" if order_entry.order.meal_type == "breakfast" else "–û–±–µ–¥" }}</span>
                                    <span class="meal-date">{{ order_entry.order.serving_date.strftime('%d.%m') }}</span>
                                </div>
                                {% if order_entry.review %}
                                <div class="review-box">
                                    "{{ order_entry.review.text[:40] }}{% if order_entry.review.text|length > 40 %}...{% endif %}"
                                </div>
                                {% endif %}
                                {% endfor %}
                            {% else %}
                                <p class="no-data">‚Äî</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: #888; text-align: center; padding: 20px;">–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
let cart = {};

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π –º–µ–Ω—é
document.querySelectorAll('.menu-item').forEach(item => {
item.addEventListener('click', function() {
// –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö
document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));

// –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–º—É
this.classList.add('active');

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–µ–∫—Ü–∏—é
const sectionId = this.dataset.section;
document.getElementById(sectionId).classList.add('active');
});
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏
const avatarInput = document.getElementById('avatar-input');
const avatarFileInput = document.getElementById('avatar-file-input');
const avatarPreview = document.getElementById('avatar-preview');
const avatarForm = document.getElementById('avatar-upload-form');

if (avatarInput && avatarFileInput) {
avatarInput.addEventListener('change', function(e) {
const file = e.target.files[0];
if (file) {
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
const reader = new FileReader();
reader.onload = function(event) {
avatarPreview.src = event.target.result;
};
reader.readAsDataURL(file);

// –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ —Å–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
avatarFileInput.files = e.target.files;
avatarForm.submit();
}
});
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
document.getElementById('add-to-cart-form')?.addEventListener('submit', function(e) {
e.preventDefault();
const select = document.getElementById('product-select');
const qtyInput = document.getElementById('quantity-input');
const product = select.value;
const quantity = parseInt(qtyInput.value) || 1;
const unit = select.options[select.selectedIndex]?.dataset.unit || '–≥';

if (!product) return;

if (cart[product]) {
cart[product].quantity += quantity;
} else {
cart[product] = { quantity, unit };
}

updateCartUI();
qtyInput.value = '1';
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–æ—Ä–∑–∏–Ω—ã
function updateCartUI() {
const list = document.getElementById('cart-list');
const emptyMsg = document.getElementById('cart-empty');

list.innerHTML = '';

if (Object.keys(cart).length === 0) {
emptyMsg.style.display = 'block';
list.style.display = 'none';
} else {
emptyMsg.style.display = 'none';
list.style.display = 'block';

for (const [product, data] of Object.entries(cart)) {
const li = document.createElement('li');
li.style.padding = '8px 0';
li.style.borderBottom = '1px solid #eee';
li.innerHTML = `
<div style="display: flex; align-items: center; gap: 10px;">
<strong>${product}</strong>
<input type="number" class="edit-qty" value="${data.quantity}"
data-product="${product}" min="1" style="width: 80px; padding: 4px;">
<span>${data.unit}</span>
<button type="button" class="remove-item" data-product="${product}">‚úï</button>
</div>
`;
list.appendChild(li);
}

document.querySelectorAll('.edit-qty').forEach(input => {
input.addEventListener('change', () => {
const qty = parseInt(input.value) || 1;
cart[input.dataset.product].quantity = Math.max(1, qty);
});
});

document.querySelectorAll('.remove-item').forEach(btn => {
btn.addEventListener('click', () => {
delete cart[btn.dataset.product];
updateCartUI();
});
});
}
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
document.getElementById('send-cart')?.addEventListener('click', () => {
if (Object.keys(cart).length === 0) {
alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
return;
}

const requestData = Object.entries(cart).map(([product, data]) => ({
product: product,
quantity: Number(data.quantity),
unit: data.unit
}));

fetch('/cook/submit_bulk_request', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Accept': 'application/json'
},
body: JSON.stringify(requestData)
})
.then(response => {
if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
return response.json();
})
.then(data => {
if (data.success) {
cart = {};
updateCartUI();
alert(data.message || '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
} else {
alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
}
})
.catch(err => {
console.error('–û—à–∏–±–∫–∞:', err);
alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞: ' + err.message);
});
});

// –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
document.getElementById('clear-cart')?.addEventListener('click', () => {
if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
cart = {};
updateCartUI();
}
});

// –ü–æ–∏—Å–∫ —É—á–µ–Ω–∏–∫–æ–≤
document.getElementById('search-students')?.addEventListener('input', function() {
const query = this.value.toLowerCase().trim();
document.querySelectorAll('.student-card').forEach(card => {
const name = card.dataset.name;
card.style.display = (query === '' || name.includes(query)) ? 'block' : 'none';
});
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã
updateCartUI();
</script>
{% endblock %}