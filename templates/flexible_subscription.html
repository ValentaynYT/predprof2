{% extends "base.html" %}
{% block title %}–ì–∏–±–∫–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç{% endblock %}
{% block header_title %}üí≥ –ì–∏–±–∫–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç{% endblock %}
{% block extra_css %}
<style>
.subscription-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.back-link {
    display: inline-block;
    margin-bottom: 20px;
    color: #4361ee;
    text-decoration: none;
    font-weight: 600;
    padding: 8px 16px;
    border-radius: 6px;
    background: #f0f4ff;
    border: 1px solid #e0e6ff;
}

.back-link:hover {
    background: #e0e8ff;
    text-decoration: none;
}

/* Flash-—Å–æ–æ–±—â–µ–Ω–∏—è */
.flash-message {
    padding: 12px 16px;
    margin-bottom: 20px;
    border-radius: 8px;
    font-weight: 600;
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
}

.flash-success { background: #2ecc71; }
.flash-error { background: #e74c3c; }
.flash-info { background: #3498db; }
.flash-warning { background: #f39c12; }

/* –ê–∫—Ç–∏–≤–Ω—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç */
.active-sub-card {
    background: #e3f2fd;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid #bbdefb;
}

.active-sub-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #1976d2;
    margin-bottom: 16px;
}

.sub-detail {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    padding: 10px;
    background: white;
    border-radius: 6px;
}

.sub-detail span {
    color: #666;
}

.sub-detail strong {
    font-weight: 600;
    color: #1976d2;
}

/* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ */
.warning-card {
    background: #fff8e1;
    border-left: 4px solid #ffc107;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 24px;
}

.warning-card p {
    margin: 0;
    color: #856404;
    font-size: 1rem;
}

/* –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ */
.period-select {
    width: 100%;
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 1rem;
    margin-bottom: 20px;
    background: white;
}

.period-select:focus {
    outline: none;
    border-color: #4361ee;
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

/* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ –¥–Ω—è–º */
.day-config-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid #e9ecef;
}

.day-config-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 20px;
}

.day-row {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid #4361ee;
}

.day-row:hover {
    background: #e8f4ff;
}

.day-name {
    font-weight: 600;
    color: #2b2d42;
    flex: 1;
    font-size: 1.1rem;
}

.meal-toggle {
    display: flex;
    align-items: center;
    gap: 24px;
}

.toggle-label {
    font-size: 0.95rem;
    color: #495057;
    margin-right: 8px;
    font-weight: 500;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #4361ee;
}

input:checked + .slider:before {
    transform: translateX(24px);
}

/* –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å */
.price-card {
    background: #e8f5e9;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid #c8e6c9;
}

.price-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #2e7d32;
    margin-bottom: 16px;
}

.total-price {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 12px 0;
    color: #1b5e20;
}

.meal-count {
    font-size: 1.2rem;
    color: #388e3c;
    margin-top: 8px;
}

/* –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á—ë—Ç–∞ */
.calculation-details {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #c8e6c9;
}

.calc-detail {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 1rem;
    padding: 8px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 6px;
}

.calc-detail strong {
    font-weight: 600;
}

/* –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã */
.btn-pay {
    width: 100%;
    padding: 14px 20px;
    background: #2ecc71;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.15rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
}

.btn-pay:hover {
    background: #27ae60;
}

.btn-pay:disabled {
    background: #95a5a6;
    cursor: not-allowed;
    opacity: 0.7;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .day-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .meal-toggle {
        width: 100%;
        justify-content: space-around;
    }

    .total-price {
        font-size: 2rem;
    }

    .btn-pay {
        font-size: 1rem;
        padding: 12px;
    }
}
/* –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å */
.price-card {
    background: #e8f5e9;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid #c8e6c9;
}

.price-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #2e7d32;
    margin-bottom: 16px;
}

.total-price {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 12px 0;
    color: #1b5e20;
}

.meal-count {
    font-size: 1.2rem;
    color: #388e3c;
    margin-top: 8px;
}

/* –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á—ë—Ç–∞ */
.calculation-details {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid #a5d6a7;
}

.calc-detail {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 10px 12px;
    background: white;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
    font-size: 1rem;
}

.calc-detail span {
    color: #546e7a;
    font-weight: 500;
}

.calc-detail strong {
    font-weight: 700;
    color: #1b5e20;
}

/* –°–µ–∫—Ü–∏—è –¥–µ—Ç–∞–ª–µ–π –ø–æ –¥–Ω—è–º */
.calc-detail-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e0e0e0;
}

.calc-detail-title {
    font-size: 1rem;
    font-weight: 600;
    color: #546e7a;
    margin-bottom: 12px;
}

.day-price-detail {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    background: #f5f5f5;
    border-radius: 6px;
    margin-bottom: 8px;
    border-left: 3px solid #4caf50;
    font-size: 0.95rem;
}

.day-price-detail span:first-child {
    color: #424242;
    font-weight: 500;
}

.day-price-detail span:last-child {
    color: #1b5e20;
    font-weight: 600;
}

/* ===== –ï–î–ò–ù–´–ô –í–´–ü–ê–î–ê–Æ–©–ò–ô –°–ü–ò–°–û–ö –î–ï–¢–ê–õ–ï–ô ===== */

.details-toggle {
    margin-top: 16px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e0e0e0;
}

.details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    color: #546e7a;
}

.details-header:hover {
    background: #e8f4ff;
}

/* ===== –°–ö–†–û–õ–õ–ò–†–£–ï–ú–´–ô –í–´–ü–ê–î–ê–Æ–©–ò–ô –°–ü–ò–°–û–ö –î–ï–¢–ê–õ–ï–ô ===== */

.details-content {
    padding: 16px 20px;
    background: white;
    max-height: 300px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    overflow-y: auto; /* –í–∫–ª—é—á–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
    display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    scrollbar-width: thin; /* –¢–æ–Ω–∫–∞—è –ø–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (–¥–ª—è Firefox) */
    scrollbar-color: #b0b0b0 #f0f0f0; /* –¶–≤–µ—Ç –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (–¥–ª—è WebKit-–±—Ä–∞—É–∑–µ—Ä–æ–≤) */
.details-content::-webkit-scrollbar {
    width: 8px;
}

.details-content::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 4px;
}

.details-content::-webkit-scrollbar-thumb {
    background: #b0b0b0;
    border-radius: 4px;
}

.details-content::-webkit-scrollbar-thumb:hover {
    background: #888;
}

/* –î–µ—Ç–∞–ª–∏ –ø–æ –¥–Ω—è–º */
.day-detail {
    margin-bottom: 16px;
    padding: 12px;
    border-radius: 6px;
    border-left: 3px solid #4caf50;
}

.meal-detail {
    margin-bottom: 16px;
    padding: 12px;
    border-radius: 6px;
    border-left: 3px solid #4caf50;
}

.breakfast-detail {
    background: #f0f8ff;
    border-left-color: #2196f3;
}

.lunch-detail {
    background: #fff0f0;
    border-left-color: #f44336;
}

.meal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e0e0e0;
}

.meal-type {
    font-weight: 700;
    font-size: 1rem;
    color: #2c3e50;
}

/* –£–±–∏—Ä–∞–µ–º –æ–±—Ä–µ–∑–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –±–ª—é–¥ */
.meal-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: #546e7a;
    max-width: 100%; /* –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
    white-space: normal; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ */
    overflow: visible; /* –£–±–∏—Ä–∞–µ–º –æ–±—Ä–µ–∑–∞–Ω–∏–µ */
    text-overflow: clip; /* –û—Ç–∫–ª—é—á–∞–µ–º –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ */
}

.meal-price {
    font-weight: 700;
    font-size: 1.1rem;
    color: #2e7d32;
}

.meal-ingredients {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #f0f0f0;
    font-size: 0.9rem;
    color: #546e7a;
}

.meal-ingredients ul {
    margin: 6px 0 0 16px;
    padding-left: 0;
    list-style-type: none;
}

.meal-ingredients li {
    margin-bottom: 3px;
    line-height: 1.4;
}
</style>
{% endblock %}

{% block content %}
<!-- üì¢ FLASH-–°–û–û–ë–©–ï–ù–ò–Ø -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="flash-message flash-{{ category if category in ['success', 'error', 'info', 'warning'] else 'info' }}">
    {% if category == 'success' %}‚úÖ{% elif category == 'error' %}‚ùå{% elif category == 'warning' %}‚ö†Ô∏è{% else %}‚ÑπÔ∏è{% endif %}
    {{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}

<a href="/student" class="back-link">‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç —É—á–µ–Ω–∏–∫–∞</a>

<div class="subscription-container">
    {% if active_sub %}
    <div class="active-sub-card">
        <div class="active-sub-title">‚úÖ –£ –≤–∞—Å –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –≥–∏–±–∫–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç</div>
        <div class="sub-detail">
            <span>üìÖ –ü–µ—Ä–∏–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è:</span>
            <strong>{{ active_sub.days_count }} –¥–Ω–µ–π</strong>
        </div>
        <div class="sub-detail">
            <span>üçΩÔ∏è –í—Å–µ–≥–æ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏:</span>
            <strong>{{ active_sub.total_meals }}</strong>
        </div>
        <div class="sub-detail">
            <span>üí∞ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
            <strong>{{ "%.2f"|format(active_sub.total_price) }} ‚ÇΩ</strong>
        </div>
        <div class="sub-detail">
            <span>‚è∞ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ:</span>
            <strong>{{ active_sub.expires_at.strftime('%d.%m.%Y') }}</strong>
        </div>
    </div>

    <div class="warning-card">
        <p>‚ö†Ô∏è –ß—Ç–æ–±—ã –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –Ω–æ–≤—ã–π –≥–∏–±–∫–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç, –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
    </div>
    {% else %}
    <h2 style="text-align: center; margin-bottom: 24px; color: #2c3e50;">üí≥ –ì–∏–±–∫–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç</h2>

    <div class="warning-card">
        <p>‚ÑπÔ∏è –ì–∏–±–∫–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–Ω–∏ –∏ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –Ω–∞ –Ω—É–∂–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –í—ã –ø–ª–∞—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∑–∞ —Ç–æ, —á—Ç–æ –∑–∞–∫–∞–∑—ã–≤–∞–µ—Ç–µ!</p>
    </div>

    <!-- –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
    <label for="subscription-period" style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 1rem; color: #2c3e50;">
        üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è:
    </label>
    <select id="subscription-period" class="period-select">
        <option value="5">1 –Ω–µ–¥–µ–ª—è (5 –¥–Ω–µ–π)</option>
        <option value="10" selected>2 –Ω–µ–¥–µ–ª–∏ (10 –¥–Ω–µ–π)</option>
        <option value="15">3 –Ω–µ–¥–µ–ª–∏ (15 –¥–Ω–µ–π)</option>
        <option value="20">4 –Ω–µ–¥–µ–ª–∏ (20 –¥–Ω–µ–π)</option>
    </select>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ -->
    <div class="day-config-card">
        <div class="day-config-title">üçΩÔ∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∏—Ç–∞–Ω–∏–µ –ø–æ –¥–Ω—è–º:</div>

        <div id="subscription-days-config">
            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
        </div>
    </div>

    <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å -->
<div class="price-card">
    <div class="price-title">üí∞ –ö –æ–ø–ª–∞—Ç–µ:</div>
    <div class="total-price">
        <span id="subscription-total-price">0.00</span> ‚ÇΩ
    </div>
    <div class="meal-count">
        <span id="subscription-total-count">0</span> –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
    </div>

    <!-- –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á—ë—Ç–∞ -->
    <div class="calculation-details">
        <div class="calc-detail">
            <span>üìÖ –ü–µ—Ä–∏–æ–¥:</span>
            <strong id="subscription-period-detail">2 –Ω–µ–¥–µ–ª–∏</strong>
        </div>
        <div class="calc-detail">
            <span>üçΩÔ∏è –ü—Ä–∏—ë–º–æ–≤ –≤ –Ω–µ–¥–µ–ª—é:</span>
            <strong id="subscription-weekly-meals">0</strong>
        </div>
        <div class="calc-detail">
            <span>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é:</span>
            <strong id="subscription-weekly-price">0.00 ‚ÇΩ</strong>
        </div>

        <!-- –î–µ—Ç–∞–ª–∏ –ø–æ –¥–Ω—è–º -->
        <div class="calc-detail-section">
            <div id="price-details">
                <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>
</div>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã -->
    <form id="subscription-form" method="post" action="/student/subscription/flexible/purchase">
        <input type="hidden" name="days_count" id="days-count-input" value="10">
        <input type="hidden" name="days_config" id="days-config-input" value='{"monday": {"breakfast": true, "lunch": true}, "tuesday": {"breakfast": true, "lunch": true}, "wednesday": {"breakfast": true, "lunch": true}, "thursday": {"breakfast": true, "lunch": true}, "friday": {"breakfast": true, "lunch": true}}'>
        <input type="hidden" name="total_price" id="total-price-input" value="0">
        <button type="submit" id="pay-subscription-btn" class="btn-pay" disabled>
            üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç
        </button>
    </form>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
const days = [
    { key: 'monday', name: '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', emoji: 'üìÖ' },
    { key: 'tuesday', name: '–í—Ç–æ—Ä–Ω–∏–∫', emoji: 'üìÖ' },
    { key: 'wednesday', name: '–°—Ä–µ–¥–∞', emoji: 'üìÖ' },
    { key: 'thursday', name: '–ß–µ—Ç–≤–µ—Ä–≥', emoji: 'üìÖ' },
    { key: 'friday', name: '–ü—è—Ç–Ω–∏—Ü–∞', emoji: 'üìÖ' }
];

const defaultConfig = {
    monday: { breakfast: true, lunch: true },
    tuesday: { breakfast: true, lunch: true },
    wednesday: { breakfast: true, lunch: true },
    thursday: { breakfast: true, lunch: true },
    friday: { breakfast: true, lunch: true }
};

let currentConfig = JSON.parse(JSON.stringify(defaultConfig));
let currentTotalPrice = 0;
let currentMealCount = 0;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
function initSubscriptionUI() {
    renderDayConfig();
    calculatePrice();
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–Ω–µ–π
function renderDayConfig() {
    const container = document.getElementById('subscription-days-config');
    container.innerHTML = '';

    days.forEach(day => {
        const dayRow = document.createElement('div');
        dayRow.className = 'day-row';
        dayRow.innerHTML = `
            <div class="day-name">${day.emoji} ${day.name}</div>
            <div class="meal-toggle">
                <label class="toggle-label">üïó –ó–∞–≤—Ç—Ä–∞–∫</label>
                <label class="toggle-switch">
                    <input type="checkbox"
                           data-day="${day.key}"
                           data-meal="breakfast"
                           ${currentConfig[day.key].breakfast ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>

                <label class="toggle-label" style="margin-left: 32px;">üïê –û–±–µ–¥</label>
                <label class="toggle-switch">
                    <input type="checkbox"
                           data-day="${day.key}"
                           data-meal="lunch"
                           ${currentConfig[day.key].lunch ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
        `;
        container.appendChild(dayRow);
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.querySelectorAll('.toggle-switch input').forEach(checkbox => {
        checkbox.addEventListener('change', handleToggleChange);
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è
function handleToggleChange(e) {
    const day = e.target.getAttribute('data-day');
    const meal = e.target.getAttribute('data-meal');
    const isChecked = e.target.checked;

    currentConfig[day][meal] = isChecked;

    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    calculatePrice();
}

// –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
function calculatePrice() {
    const daysCount = parseInt(document.getElementById('subscription-period').value);
    const periodText = document.getElementById('subscription-period').options[
        document.getElementById('subscription-period').selectedIndex
    ].text;

    // === –ü–†–û–í–ï–†–ö–ê: –ï–°–¢–¨ –õ–ò –í–´–ë–†–ê–ù–ù–´–ï –ü–†–ò–Å–ú–´ –ü–ò–©–ò ===
    let hasSelectedMeals = false;
    for (const day in currentConfig) {
        if (currentConfig[day].breakfast || currentConfig[day].lunch) {
            hasSelectedMeals = true;
            break;
        }
    }

    // –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤ - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    if (!hasSelectedMeals) {
        document.getElementById('subscription-total-price').textContent = '0.00';
        document.getElementById('subscription-total-count').textContent = '0';
        document.getElementById('pay-subscription-btn').disabled = true;
        document.getElementById('price-details').innerHTML = '<p style="color: #999; text-align: center; padding: 16px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π</p>';
        return;
    }

    fetch('/api/flexible-subscription/calculate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            days_count: daysCount,
            days_config: currentConfig
        })
    })
    .then(response => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        if (!response.ok) {
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            currentTotalPrice = data.total_price;
            currentMealCount = data.meal_count;

            // –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
            document.getElementById('subscription-total-price').textContent = currentTotalPrice.toFixed(2);
            document.getElementById('subscription-total-count').textContent = currentMealCount;

            // –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á—ë—Ç–∞
            document.getElementById('subscription-period-detail').textContent = periodText;

            // –ü—Ä–∏—ë–º—ã –≤ –Ω–µ–¥–µ–ª—é - —Å—á–∏—Ç–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            let weeklyMeals = 0;
            for (const day in currentConfig) {
                if (currentConfig[day].breakfast) weeklyMeals++;
                if (currentConfig[day].lunch) weeklyMeals++;
            }
            document.getElementById('subscription-weekly-meals').textContent = weeklyMeals;

            // –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é ‚Äî –±–µ—Ä—ë–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
            const weeklyPrice = data.total_price / data.weeks_count;
            document.getElementById('subscription-weekly-price').textContent = weeklyPrice.toFixed(2) + ' ‚ÇΩ';

            // === –û–ë–ù–û–í–õ–Å–ù–ù–´–ô –ë–õ–û–ö: –ï–î–ò–ù–´–ô –í–´–ü–ê–î–ê–Æ–©–ò–ô –°–ü–ò–°–û–ö –î–ï–¢–ê–õ–ï–ô ===
            const priceDetails = document.getElementById('price-details');
            if (priceDetails && data.meal_details && data.selected_meals) {
                // –°–æ–±–∏—Ä–∞–µ–º –¥–µ—Ç–∞–ª–∏ –≤—Å–µ—Ö –¥–Ω–µ–π
                let daysDetailsHTML = '';
                days.forEach(day => {
                    const selected = data.selected_meals[day.key];
                    const mealInfo = data.meal_details[day.key];

                    if (selected && (selected.breakfast || selected.lunch)) {
                        daysDetailsHTML += `
                            <div class="day-detail">
                                <div style="font-weight: 700; margin: 12px 0 8px; display: flex; justify-content: space-between;">
                                    <span>${day.name}</span>
                                    <span style="color: #2e7d32; font-weight: 600;">${(selected.breakfast_price + selected.lunch_price).toFixed(2)} ‚ÇΩ</span>
                                </div>
                        `;

                        // –ó–∞–≤—Ç—Ä–∞–∫
                        if (selected.breakfast && mealInfo.breakfast) {
                            const breakfast = mealInfo.breakfast;
                            daysDetailsHTML += `
                                <div class="meal-detail breakfast-detail">
                                    <div class="meal-header">
                                        <span class="meal-type">üïó –ó–∞–≤—Ç—Ä–∞–∫</span>
                                        <span class="meal-name">${breakfast.name}</span>
                                        <span class="meal-price">${selected.breakfast_price.toFixed(2)} ‚ÇΩ</span>
                                    </div>
                                    ${breakfast.ingredients && breakfast.ingredients.length > 0 ? `
                                        <div class="meal-ingredients">
                                            <strong>üìã –°–æ—Å—Ç–∞–≤:</strong>
                                            <ul>
                                                ${breakfast.ingredients.map(ing => `
                                                    <li>‚Ä¢ ${ing.name} ${ing.quantity ? '(' + (ing.quantity % 1 === 0 ? ing.quantity : ing.quantity.toFixed(1)) + ' ' + ing.unit + ')' : ''}</li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }

                        // –û–±–µ–¥
                        if (selected.lunch && mealInfo.lunch) {
                            const lunch = mealInfo.lunch;
                            daysDetailsHTML += `
                                <div class="meal-detail lunch-detail">
                                    <div class="meal-header">
                                        <span class="meal-type">üïê –û–±–µ–¥</span>
                                        <span class="meal-name">${lunch.name}</span>
                                        <span class="meal-price">${selected.lunch_price.toFixed(2)} ‚ÇΩ</span>
                                    </div>
                                    ${lunch.ingredients && lunch.ingredients.length > 0 ? `
                                        <div class="meal-ingredients">
                                            <strong>üìã –°–æ—Å—Ç–∞–≤:</strong>
                                            <ul>
                                                ${lunch.ingredients.map(ing => `
                                                    <li>‚Ä¢ ${ing.name} ${ing.quantity ? '(' + (ing.quantity % 1 === 0 ? ing.quantity : ing.quantity.toFixed(1)) + ' ' + ing.unit + ')' : ''}</li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }

                        daysDetailsHTML += `</div>`;
                    }
                });

                // –§–æ—Ä–º–∏—Ä—É–µ–º –µ–¥–∏–Ω—ã–π –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                const detailsHTML = `
                    <div class="details-toggle">
                        <div class="details-header" onclick="toggleDetails(this)">
                            <span>üìã –î–µ—Ç–∞–ª–∏ –ø–æ –¥–Ω—è–º</span>
                            <span class="toggle-icon">‚ñ∂</span>
                        </div>
                        <div class="details-content">
                            ${daysDetailsHTML || '<p style="color: #999; text-align: center; padding: 16px;">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</p>'}
                        </div>
                    </div>
                `;

                priceDetails.innerHTML = detailsHTML;

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
                document.querySelector('.details-content').style.display = 'none';
            } else {
                priceDetails.innerHTML = '<p style="color: #999; text-align: center; padding: 16px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π</p>';
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
            document.getElementById('total-price-input').value = currentTotalPrice;
            document.getElementById('days-count-input').value = daysCount;
            document.getElementById('days-config-input').value = JSON.stringify(currentConfig);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ —Å–¥–≤–∏–≥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é
            if (data.needs_shift) {
                document.getElementById('days-config-input').setAttribute('data-needs-shift', 'true');
            } else {
                document.getElementById('days-config-input').removeAttribute('data-needs-shift');
            }

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏—ë–º –ø–∏—â–∏
            document.getElementById('pay-subscription-btn').disabled = currentMealCount === 0;
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞:', error);
        // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã–±—Ä–∞–Ω—ã —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏—ë–º –ø–∏—â–∏ –∏ –≤—Å–µ –±–ª—é–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã.');
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
document.getElementById('subscription-period').addEventListener('change', function() {
    calculatePrice();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', initSubscriptionUI);

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ —Å–¥–≤–∏–≥–∞ –≤ —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
document.getElementById('subscription-form').addEventListener('submit', function(e) {
    const needsShift = document.getElementById('days-config-input').getAttribute('data-needs-shift') === 'true';
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'needs_shift';
    hiddenInput.value = needsShift;
    this.appendChild(hiddenInput);
});

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –µ–¥–∏–Ω–æ–≥–æ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
function toggleDetails(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');

    if (content.style.display === 'block') {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
    } else {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
    }

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤ –Ω–∞—á–∞–ª–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    if (content.style.display === 'block') {
        content.scrollTop = 0;
    }
}
</script>
{% endblock %}