{% extends "base.html" %}
{% block title %}–£—á–µ–Ω–∏–∫–∏{% endblock %}
{% block header_title %}üë• –£—á–µ–Ω–∏–∫–∏{% endblock %}
{% block extra_css %}
<style>
.student-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
    transition: all 0.3s;
}
.student-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}
.student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.student-name {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2b2d42;
}
.student-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-top: 12px;
}
.info-item {
    background: #f8f9ff;
    padding: 10px;
    border-radius: 6px;
    border-left: 3px solid #4361ee;
}
.info-label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 4px;
}
.info-value {
    font-weight: 500;
    color: #2b2d42;
}
.btn-group {
    display: flex;
    gap: 8px;
}
.btn-edit {
    background: #4361ee;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}
.btn-edit:hover {
    background: #3a56e4;
}
.btn-delete {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}
.btn-delete:hover {
    background: #c0392b;
}
.add-student-btn {
    background: #2ecc71;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 600;
    margin-bottom: 20px;
    cursor: pointer;
    transition: all 0.3s;
}
.add-student-btn:hover {
    background: #27ae60;
    transform: translateY(-2px);
}
.flash-message {
    padding: 12px;
    margin-bottom: 20px;
    border-radius: 8px;
    font-weight: bold;
    color: white;
}
.flash-success { background: #2ecc71; }
.flash-error { background: #e74c3c; }
.flash-info { background: #3498db; }
.flash-warning { background: #f39c12; }
.archive-link {
    display: inline-block;
    background: #6c757d;
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 20px;
    transition: all 0.3s;
}
.archive-link:hover {
    background: #5a6268;
    transform: translateY(-2px);
}
.archive-link span {
    margin-left: 8px;
}

/* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ */
#search-students {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    margin-bottom: 20px;
    transition: all 0.3s;
}
#search-students:focus {
    outline: none;
    border-color: #4361ee;
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}
#search-students::placeholder {
    color: #6c757d;
}

/* –°—Ç–∏–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" */
.no-results {
    text-align: center;
    padding: 40px;
    color: #6c757d;
    display: none;
}
.no-results.show {
    display: block;
}
.no-results-icon {
    font-size: 3rem;
    margin-bottom: 16px;
}
.flexible-sub-active {
    background: #e8f5e9;
    border-left: 4px solid #4caf50;
}
.flexible-sub-inactive {
    color: #6c757d;
}
</style>
{% endblock %}
{% block content %}
<!-- üì¢ FLASH-–°–û–û–ë–©–ï–ù–ò–Ø -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="flash-message flash-{{ category if category in ['success', 'error'] else 'info' }}">
    {{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}

<a href="/admin" class="back-link">‚Üê –ù–∞–∑–∞–¥ –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</a>

<h2>–°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤ ({{ students|length }})</h2>

<input type="text" id="search-students" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û...">

<!-- –°–æ–æ–±—â–µ–Ω–∏–µ "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" -->
<div id="no-results" class="no-results">
    <div class="no-results-icon">üîç</div>
    <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
</div>

{% if students %}
    {% for item in students %}
        <div class="student-card" data-name="{{ item.student.full_name | lower }}">
            <div class="student-header">
                <div class="student-name">
                    {{ item.student.full_name }}
                </div>
                <div class="btn-group">
                    <button class="btn-edit" onclick="window.location.href='/admin/student/{{ item.student.id }}/edit'">
                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn-delete" onclick="confirmDelete({{ item.student.id }}, '{{ item.student.full_name }}')">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>

            <div class="student-info">
                <div class="info-item">
                    <div class="info-label">–ö–ª–∞—Å—Å</div>
                    <div class="info-value">{{ item.student.class_name or '‚Äî' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ item.student.email }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ë–∞–ª–∞–Ω—Å</div>
                    <div class="info-value">{{ "%.2f"|format(item.student.balance) }} ‚ÇΩ</div>
                </div>
                <!-- –î–û–ë–ê–í–õ–Ø–ï–ú –ò–ù–§–û–†–ú–ê–¶–ò–Æ –û –ì–ò–ë–ö–û–ú –ê–ë–û–ù–ï–ú–ï–ù–¢–ï -->
                <div class="info-item">
                    <div class="info-label">–ì–∏–±–∫–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç</div>
                    <div class="info-value {% if item.flexible_sub %}flexible-sub-active{% else %}flexible-sub-inactive{% endif %}">
                        {% if item.flexible_sub %}
                            ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω –¥–æ {{ item.flexible_sub.expires_at.strftime('%d.%m.%Y') }}<br>
                            üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {{ "%.2f"|format(item.flexible_sub.total_price) }} ‚ÇΩ<br>
                            üçΩÔ∏è –ü—Ä–∏—ë–º—ã: {{ item.flexible_sub.total_meals }}
                        {% else %}
                            ‚ùå –ù–µ—Ç
                        {% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ê–ª–ª–µ—Ä–≥–∏–∏</div>
                    <div class="info-value">{{ item.allergy }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                    <div class="info-value">
                        {{ item.student.timestamp.strftime('%d.%m.%Y') if item.student.timestamp else '‚Äî' }}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% else %}
    <div style="text-align: center; padding: 40px; color: #6c757d;">
        <div style="font-size: 3rem; margin-bottom: 16px;">üì≠</div>
        <p>–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</p>
    </div>
{% endif %}

{% endblock %}
{% block extra_js %}
<script>
function confirmDelete(studentId, studentName) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ "${studentName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
        // –°–æ–∑–¥–∞—ë–º —Ñ–æ—Ä–º—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/student/${studentId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –§–ò–û
function searchStudents() {
    const searchTerm = document.getElementById('search-students').value.toLowerCase().trim();
    const studentCards = document.querySelectorAll('.student-card');
    const noResultsDiv = document.getElementById('no-results');
    let visibleCount = 0;

    studentCards.forEach(card => {
        const studentName = card.getAttribute('data-name');

        if (searchTerm === '' || studentName.includes(searchTerm)) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    if (visibleCount === 0 && searchTerm !== '') {
        noResultsDiv.classList.add('show');
    } else {
        noResultsDiv.classList.remove('show');
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
document.getElementById('search-students').addEventListener('input', searchStudents);
</script>
{% endblock %}