<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á—ë—Ç—ã ‚Äî –ê–¥–º–∏–Ω–∫–∞</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        .report-table th,
        .report-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .report-table th {
            background: #f0f4ff;
        }
        .total-row {
            font-weight: bold;
            background: #e8f5e9;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞ */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 12px 0;
            flex-wrap: wrap;
        }
        .btn-export {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-excel {
            background: #217346;
            color: white;
        }
        .btn-excel:hover {
            background: #1a5a37;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(33, 115, 70, 0.3);
        }
        .btn-csv {
            background: #1565c0;
            color: white;
        }
        .btn-csv:hover {
            background: #0d4a8a;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(21, 101, 192, 0.3);
        }
        .btn-png {
            background: #e74c3c;
            color: white;
        }
        .btn-png:hover {
            background: #c0392b;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }
        .btn-copy {
            background: #6c757d;
            color: white;
        }
        .btn-copy:hover {
            background: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
        }
        .btn-all {
            padding: 12px 24px;
            font-size: 15px;
            margin: 10px 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-all:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .btn-all-excel {
            background: #217346;
            color: white;
        }
        .btn-all-excel:hover {
            background: #1a5a37;
            box-shadow: 0 4px 12px rgba(33, 115, 70, 0.4);
        }
        .btn-all-csv {
            background: #1565c0;
            color: white;
        }
        .btn-all-csv:hover {
            background: #0d4a8a;
            box-shadow: 0 4px 12px rgba(21, 101, 192, 0.4);
        }
        /* –ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –¥–∏–∑–∞–π–Ω —Å–µ–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ */
        .export-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .export-section h2 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .export-section p {
            color: #6c757d;
            font-size: 14px;
            margin: 10px 0 0 0;
            font-style: italic;
        }
        .export-btn-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .filter-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-form {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            margin: 0;
        }
        .filter-group input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }
        .filter-group input[type="date"]:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        .filter-btn {
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .filter-btn-apply {
            background: #4361ee;
            color: white;
        }
        .filter-btn-apply:hover {
            background: #3a56d4;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(67, 97, 238, 0.3);
        }
        .filter-btn-reset {
            background: #6c757d;
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .filter-btn-reset:hover {
            background: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(108, 117, 125, 0.3);
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–π –æ—Ç—á—ë—Ç–æ–≤ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }
        .card h2 {
            margin-top: 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: white;
            color: #333;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 280px;
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <header>
        <h1>üìä –û—Ç—á—ë—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥: {{ start_date }} ‚Äî {{ end_date }}</h1>
    </header>
    <div class="container">
        <a href="/admin" class="back-link">‚Üê –ù–∞–∑–∞–¥ –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</a>

        <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
        <div class="filter-section">
            <h3>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –æ—Ç—á—ë—Ç–∞</h3>
            <form method="get" class="filter-form">
                <div class="filter-group">
                    <label for="start_date">–°:</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}" required>
                </div>
                <div class="filter-group">
                    <label for="end_date">–ü–æ:</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}" required>
                </div>
                <button type="submit" class="filter-btn filter-btn-apply">
                    <span>‚úì</span> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
                <a href="/admin/reports" class="filter-btn filter-btn-reset">
                    <span>‚Ü∫</span> –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </form>
        </div>

        <!-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç -->
        <div class="card" id="section-revenue">
            <h2>üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç</h2>
            <p><strong>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞:</strong> {{ "%.2f"|format(total_revenue) }} ‚ÇΩ</p>
            <div class="export-buttons">
                <button onclick="exportTableToExcel('revenue-table')" class="btn-export btn-excel">üìä Excel</button>
                <button onclick="exportTableToCSV('revenue-table')" class="btn-export btn-csv">üìÑ CSV</button>
                <button onclick="exportChart('revenueChart')" class="btn-export btn-png">üñºÔ∏è PNG</button>
                <button onclick="copyTableToClipboard('revenue-table')" class="btn-export btn-copy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <table class="report-table" id="revenue-table">
                <thead>
                    <tr>
                        <th>–î–µ–Ω—å</th>
                        <th>–ó–∞–≤—Ç—Ä–∞–∫–∏ (‚ÇΩ)</th>
                        <th>–û–±–µ–¥—ã (‚ÇΩ)</th>
                        <th>–ò—Ç–æ–≥–æ (‚ÇΩ)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day in days %}
                    <tr>
                        <td>{{ day_names[day] }}</td>
                        <td>{{ "%.2f"|format(revenue_by_day[day].breakfast) }}</td>
                        <td>{{ "%.2f"|format(revenue_by_day[day].lunch) }}</td>
                        <td>{{ "%.2f"|format(revenue_by_day[day].total) }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td><strong>–í—Å–µ–≥–æ</strong></td>
                        <td><strong>{{ "%.2f"|format(revenue_by_day.values()|sum(attribute='breakfast')) }}</strong></td>
                        <td><strong>{{ "%.2f"|format(revenue_by_day.values()|sum(attribute='lunch')) }}</strong></td>
                        <td><strong>{{ "%.2f"|format(total_revenue) }}</strong></td>
                    </tr>
                </tbody>
            </table>
            <!-- –ì—Ä–∞—Ñ–∏–∫ –≤—ã—Ä—É—á–∫–∏ -->
            <canvas id="revenueChart" height="100"></canvas>
        </div>

        <!-- –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã -->
        <div class="card" id="section-deficit">
            <h2>üõí –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –∑–∞–∫—É–ø–∫—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h2>
            <p><strong>–†–∞—Å—á—ë—Ç–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤:</strong> {{ "%.2f"|format(total_cost_deficit) }} ‚ÇΩ</p>
            <p><strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ –∑–∞–∫—É–ø–∫–∏:</strong> {{ "%.2f"|format(total_spent) }} ‚ÇΩ</p>
            <div class="export-buttons">
                <button onclick="exportTableToExcel('deficit-table')" class="btn-export btn-excel">üìä Excel</button>
                <button onclick="exportTableToCSV('deficit-table')" class="btn-export btn-csv">üìÑ CSV</button>
                <button onclick="copyTableToClipboard('deficit-table')" class="btn-export btn-copy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            {% if deficit_details %}
            <table class="report-table" id="deficit-table">
                <thead>
                    <tr>
                        <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                        <th>–ù—É–∂–Ω–æ</th>
                        <th>–ï—Å—Ç—å</th>
                        <th>–î–µ—Ñ–∏—Ü–∏—Ç</th>
                        <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in deficit_details %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ "%.1f"|format(item.needed) }} {{ item.unit }}</td>
                        <td>{{ "%.1f"|format(item.current) }} {{ item.unit }}</td>
                        <td style="color: #e74c3c;"><strong>{{ "%.1f"|format(item.deficit) }} {{ item.unit }}</strong></td>
                        <td>{{ "%.2f"|format(item.cost) }} ‚ÇΩ</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –Ω–∞–ª–∏—á–∏–∏ ‚Äî –∑–∞–∫—É–ø–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.</p>
            {% endif %}
        </div>

        <!-- –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
        <div class="card" id="section-usage">
            <h2>üìã –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h2>
            <p><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤:</strong> {{ "%.2f"|format(total_usage_cost) }} ‚ÇΩ</p>
            <div class="export-buttons">
                <button onclick="exportTableToExcel('usage-table')" class="btn-export btn-excel">üìä Excel</button>
                <button onclick="exportTableToCSV('usage-table')" class="btn-export btn-csv">üìÑ CSV</button>
                <button onclick="copyTableToClipboard('usage-table')" class="btn-export btn-copy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            {% if usage_list %}
            <table class="report-table" id="usage-table">
                <thead>
                    <tr>
                        <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                        <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
                        <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in usage_list %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ "%.1f"|format(item.fact_qty) }} {{ item.unit }}</td>
                        <td>{{ "%.2f"|format(item.fact_cost) }} ‚ÇΩ</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã–¥–∞–Ω–Ω—ã—Ö –±–ª—é–¥–∞—Ö.</p>
            {% endif %}
        </div>

        <!-- –ü–ª–∞–Ω vs –§–∞–∫—Ç -->
        <div class="card" id="section-plan-vs-fact">
            <h2>üìä –ü–ª–∞–Ω vs –§–∞–∫—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º</h2>
            <div class="export-buttons">
                <button onclick="exportTableToExcel('planvsfact-table')" class="btn-export btn-excel">üìä Excel</button>
                <button onclick="exportTableToCSV('planvsfact-table')" class="btn-export btn-csv">üìÑ CSV</button>
                <button onclick="exportChart('planVsFactChart')" class="btn-export btn-png">üñºÔ∏è PNG</button>
                <button onclick="copyTableToClipboard('planvsfact-table')" class="btn-export btn-copy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            {% if plan_vs_fact %}
            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 16px;">
                <table class="report-table" id="planvsfact-table" style="margin: 0;">
                    <thead style="position: sticky; top: 0; background: #f0f4ff; z-index: 10;">
                        <tr>
                            <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                            <th>–ü–ª–∞–Ω</th>
                            <th>–§–∞–∫—Ç</th>
                            <th>–û—Ç–∫–ª. (–µ–¥.)</th>
                            <th>–û—Ç–∫–ª. (‚ÇΩ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in plan_vs_fact %}
                        <tr>
                            <td>{{ item.name }}</td>
                            <td>{{ "%.1f"|format(item.plan_qty) }} {{ item.unit }}</td>
                            <td>{{ "%.1f"|format(item.fact_qty) }} {{ item.unit }}</td>
                            <td style="color: {% if item.deviation_qty > 0 %}#e74c3c{% elif item.deviation_qty < 0 %}#2ecc71{% else %}#666{% endif %};">
                                {{ "%.1f"|format(item.deviation_qty) }} {{ item.unit }}
                            </td>
                            <td style="color: {% if item.deviation_cost > 0 %}#e74c3c{% elif item.deviation_cost < 0 %}#2ecc71{% else %}#666{% endif %};">
                                {{ "%.2f"|format(item.deviation_cost) }} ‚ÇΩ
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.</p>
            {% endif %}
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è -->
            <div style="display: flex; justify-content: center; gap: 24px; margin: 16px 0; font-weight: 500;">
                <label style="display: flex; align-items: center; gap: 6px;">
                    <input type="radio" name="unit-mode" value="qty" checked onchange="updatePlanVsFactChart()">
                    –ï–¥. –∏–∑–º.
                </label>
                <label style="display: flex; align-items: center; gap: 6px;">
                    <input type="radio" name="unit-mode" value="cost" onchange="updatePlanVsFactChart()">
                    ‚ÇΩ
                </label>
            </div>
            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞–Ω/—Ñ–∞–∫—Ç (—Ç–æ–ø-10 –ø—Ä–æ–¥—É–∫—Ç–æ–≤) -->
            <canvas id="planVsFactChart" height="200"></canvas>
        </div>

        <!-- –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å -->
        <div class="card" id="section-attendance">
            <h2>üë• –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å (–≤—ã–¥–∞–Ω–æ)</h2>
            <div class="export-buttons">
                <button onclick="exportTableToExcel('attendance-table')" class="btn-export btn-excel">üìä Excel</button>
                <button onclick="exportTableToCSV('attendance-table')" class="btn-export btn-csv">üìÑ CSV</button>
                <button onclick="exportChart('attendanceChart')" class="btn-export btn-png">üñºÔ∏è PNG</button>
                <button onclick="copyTableToClipboard('attendance-table')" class="btn-export btn-copy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <table class="report-table" id="attendance-table">
                <thead>
                    <tr>
                        <th>–î–µ–Ω—å</th>
                        <th>–ó–∞–≤—Ç—Ä–∞–∫–∏</th>
                        <th>–û–±–µ–¥—ã</th>
                        <th>–í—Å–µ–≥–æ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day in days %}
                    <tr>
                        <td>{{ day_names[day] }}</td>
                        <td>{{ attendance_by_day[day].breakfast }}</td>
                        <td>{{ attendance_by_day[day].lunch }}</td>
                        <td>{{ attendance_by_day[day].total }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td><strong>–ò—Ç–æ–≥–æ</strong></td>
                        <td><strong>{{ attendance_by_day.values()|sum(attribute='breakfast') }}</strong></td>
                        <td><strong>{{ attendance_by_day.values()|sum(attribute='lunch') }}</strong></td>
                        <td><strong>{{ attendance_by_day.values()|sum(attribute='total') }}</strong></td>
                    </tr>
                </tbody>
            </table>
            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ -->
            <canvas id="attendanceChart" height="100"></canvas>
        </div>

        <!-- –†—É—á–Ω—ã–µ —Å–ø–∏—Å–∞–Ω–∏—è -->
        <div class="card" id="section-writeoffs">
            <h2>üóëÔ∏è –†—É—á–Ω—ã–µ —Å–ø–∏—Å–∞–Ω–∏—è (–ø–æ—Ä—á–∞, –æ—à–∏–±–∫–∞)</h2>
            <p><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–ø–∏—Å–∞–Ω–∏–π:</strong> {{ "%.2f"|format(total_manual_cost) }} ‚ÇΩ</p>
            <div class="export-buttons">
                <button onclick="exportTableToExcel('writeoffs-table')" class="btn-export btn-excel">üìä Excel</button>
                <button onclick="exportTableToCSV('writeoffs-table')" class="btn-export btn-csv">üìÑ CSV</button>
                <button onclick="copyTableToClipboard('writeoffs-table')" class="btn-export btn-copy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            {% if manual_write_offs %}
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px;">
                <table class="report-table" id="writeoffs-table" style="margin: 0;">
                    <thead style="position: sticky; top: 0; background: #fff8e1;">
                        <tr>
                            <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                            <th>–ö–æ–ª-–≤–æ</th>
                            <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                            <th>–ü–æ–≤–∞—Ä</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for w in manual_write_offs %}
                        <tr>
                            <td>{{ w.product }}</td>
                            <td>{{ "%.1f"|format(w.quantity) }} {{ w.unit }}</td>
                            <td>{{ w.reason }}</td>
                            <td>{{ w.cook_name }}</td>
                            <td>{{ w.date }}</td>
                            <td>{{ "%.2f"|format(w.cost) }} ‚ÇΩ</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>–ù–µ—Ç —Ä—É—á–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π.</p>
            {% endif %}
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤—Å–µ–≥–æ –æ—Ç—á—ë—Ç–∞ -->
        <div class="export-section">
            <h2>üì§ –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞</h2>
            <p>–°–∫–∞—á–∞–π—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            <div class="export-btn-group">
                <button onclick="exportAllToExcel()" class="btn-all btn-all-excel">
                    <span>üìä</span> –í–µ—Å—å –æ—Ç—á—ë—Ç –≤ Excel
                </button>
                <button onclick="exportAllToCSV()" class="btn-all btn-all-csv">
                    <span>üìÑ</span> –í–µ—Å—å –æ—Ç—á—ë—Ç –≤ CSV
                </button>
            </div>
        </div>

        <a href="/logout" class="logout-link">üö™ –í—ã–π—Ç–∏</a>
    </div>

    <script>
        // === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
        let revenueChart = null;
        let attendanceChart = null;
        let planVsFactChart = null;

        // === –í—ã—Ä—É—á–∫–∞ ===
        document.addEventListener('DOMContentLoaded', function() {
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: {{ chart_days|tojson }},
                    datasets: [{
                        label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
                        data: {{ chart_revenue|tojson }},
                        backgroundColor: '#4361ee'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // === –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å ===
            const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
            attendanceChart = new Chart(attendanceCtx, {
                type: 'bar',
                data: {
                    labels: {{ chart_days|tojson }},
                    datasets: [
                        {
                            label: '–ó–∞–≤—Ç—Ä–∞–∫–∏',
                            data: {{ chart_breakfasts|tojson }},
                            backgroundColor: '#2ecc71'
                        },
                        {
                            label: '–û–±–µ–¥—ã',
                            data: {{ chart_lunches|tojson }},
                            backgroundColor: '#e74c3c'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // === –ü–ª–∞–Ω vs –§–∞–∫—Ç ===
            const planVsFactData = {{ top_10_plan_vs_fact|tojson }};
            createOrUpdatePlanVsFactChart('qty');
        });

        function createOrUpdatePlanVsFactChart(mode = 'qty') {
            const ctx = document.getElementById('planVsFactChart').getContext('2d');
            if (planVsFactChart) planVsFactChart.destroy();

            const planVsFactData = {{ top_10_plan_vs_fact|tojson }};
            const labels = planVsFactData.map(item => item.name);
            let planData, factData;

            if (mode === 'cost') {
                planData = planVsFactData.map(item => item.plan_cost);
                factData = planVsFactData.map(item => item.fact_cost);
            } else {
                planData = planVsFactData.map(item => item.plan_qty);
                factData = planVsFactData.map(item => item.fact_qty);
            }

            planVsFactChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '–ü–ª–∞–Ω',
                            data: planData,
                            backgroundColor: '#3498db'
                        },
                        {
                            label: '–§–∞–∫—Ç',
                            data: factData,
                            backgroundColor: '#e67e22'
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }

        function updatePlanVsFactChart() {
            const mode = document.querySelector('input[name="unit-mode"]:checked').value;
            createOrUpdatePlanVsFactChart(mode);
        }

        // === –≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü—ã –≤ Excel ===
        function exportTableToExcel(tableId, filenamePrefix = '') {
            const table = document.getElementById(tableId);
            if (!table || !table.querySelector('tbody tr')) {
                showToast('‚ùå –¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –ø—É—Å—Ç–∞!');
                return;
            }

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ –ª–∏—Å—Ç
            const ws = XLSX.utils.table_to_sheet(table, {
                raw: true,
                dateNF: 'dd/mm/yyyy'
            });

            // –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
            const wscols = [];
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                let maxWidth = 10;
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    const cellAddress = { c: C, r: R };
                    const cellRef = XLSX.utils.encode_cell(cellAddress);
                    const cell = ws[cellRef];
                    if (cell && cell.v) {
                        const cellValue = String(cell.v);
                        maxWidth = Math.max(maxWidth, cellValue.length);
                    }
                }
                wscols.push({ wch: Math.min(maxWidth + 2, 30) });
            }
            ws['!cols'] = wscols;

            // –°–æ–∑–¥–∞—ë–º —Ä–∞–±–æ—á—É—é –∫–Ω–∏–≥—É
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–û—Ç—á—ë—Ç');

            // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
            const prefix = filenamePrefix || tableId;
            const dateStr = new Date().toISOString().slice(0, 10);
            const filename = `${prefix}_${dateStr}.xlsx`;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
            XLSX.writeFile(wb, filename);
            showToast('‚úÖ –¢–∞–±–ª–∏—Ü–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ Excel!');
        }

        // === –≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü—ã –≤ CSV ===
        function exportTableToCSV(tableId, filenamePrefix = '') {
            const table = document.getElementById(tableId);
            if (!table || !table.querySelector('tbody tr')) {
                showToast('‚ùå –¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –ø—É—Å—Ç–∞!');
                return;
            }

            const rows = table.querySelectorAll('tr');
            let csvContent = '';
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = Array.from(cols).map(col => {
                    let text = col.innerText.trim().replace(/\n/g, ' ');
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    return text;
                });
                csvContent += rowData.join(',') + '\n';
            });

            const blob = new Blob(['\ufeff' + csvContent], {
                type: 'text/csv;charset=utf-8;'
            });

            const prefix = filenamePrefix || tableId;
            const dateStr = new Date().toISOString().slice(0, 10);
            const filename = `${prefix}_${dateStr}.csv`;

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            showToast('‚úÖ –¢–∞–±–ª–∏—Ü–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ CSV!');
        }

        // === –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ ===
        function copyTableToClipboard(tableId) {
            const table = document.getElementById(tableId);
            if (!table) {
                showToast('‚ùå –¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                return;
            }

            const rows = table.querySelectorAll('tr');
            let textContent = '';
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = Array.from(cols).map(col => col.innerText.trim());
                textContent += rowData.join('\t') + '\n';
            });

            navigator.clipboard.writeText(textContent).then(() => {
                showToast('üìã –¢–∞–±–ª–∏—Ü–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                showToast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            });
        }

        // === –≠–∫—Å–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –≤ PNG ===
        function exportChart(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                showToast('‚ùå –ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }

            const link = document.createElement('a');
            link.download = `${canvasId}_${new Date().toISOString().slice(0, 10)}.png`;

            // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas —Å –±–µ–ª—ã–º —Ñ–æ–Ω–æ–º
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width || 800;
            tempCanvas.height = canvas.height || 400;
            const ctx = tempCanvas.getContext('2d');

            // –ó–∞–ª–∏–≤–∞–µ–º –±–µ–ª—ã–º —Ñ–æ–Ω–æ–º
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            // –†–∏—Å—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π canvas –ø–æ–≤–µ—Ä—Ö –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞
            ctx.drawImage(canvas, 0, 0);

            link.href = tempCanvas.toDataURL('image/png');
            link.click();
            showToast('‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ PNG!');
        }

        // === –≠–∫—Å–ø–æ—Ä—Ç –í–°–ï–ì–û –æ—Ç—á—ë—Ç–∞ –≤ Excel ===
        function exportAllToExcel() {
            const wb = XLSX.utils.book_new();
            let exportedCount = 0;
            let skippedCount = 0;

            const tables = [
                { id: 'revenue-table', name: '–§–∏–Ω–∞–Ω—Å—ã' },
                { id: 'deficit-table', name: '–î–µ—Ñ–∏—Ü–∏—Ç_–ø—Ä–æ–¥—É–∫—Ç–æ–≤' },
                { id: 'usage-table', name: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ' },
                { id: 'planvsfact-table', name: '–ü–ª–∞–Ω_vs_–§–∞–∫—Ç' },
                { id: 'attendance-table', name: '–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å' },
                { id: 'writeoffs-table', name: '–°–ø–∏—Å–∞–Ω–∏—è' }
            ];

            tables.forEach(tableInfo => {
                const table = document.getElementById(tableInfo.id);
                if (table && table.querySelector('tbody tr')) {
                    try {
                        const ws = XLSX.utils.table_to_sheet(table, {
                            raw: true,
                            dateNF: 'dd/mm/yyyy'
                        });

                        // –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
                        const wscols = [];
                        const range = XLSX.utils.decode_range(ws['!ref']);
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            let maxWidth = 10;
                            for (let R = range.s.r; R <= range.e.r; ++R) {
                                const cellAddress = { c: C, r: R };
                                const cellRef = XLSX.utils.encode_cell(cellAddress);
                                const cell = ws[cellRef];
                                if (cell && cell.v) {
                                    const cellValue = String(cell.v);
                                    maxWidth = Math.max(maxWidth, cellValue.length);
                                }
                            }
                            wscols.push({ wch: Math.min(maxWidth + 2, 30) });
                        }
                        ws['!cols'] = wscols;

                        const sheetName = tableInfo.name.substring(0, 31);
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                        exportedCount++;
                    } catch (e) {
                        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ ${tableInfo.id}:`, e);
                        skippedCount++;
                    }
                } else {
                    skippedCount++;
                }
            });

            if (exportedCount === 0) {
                showToast('‚ùå –ù–µ—Ç —Ç–∞–±–ª–∏—Ü –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!');
                return;
            }

            const dateStr = new Date().toISOString().slice(0, 10);
            const period = '{{ start_date }}_{{ end_date }}'.replace(/[^a-zA-Z0-9_-]/g, '_');
            const filename = `–ü–æ–ª–Ω—ã–π_–æ—Ç—á—ë—Ç_${period}_${dateStr}.xlsx`;

            XLSX.writeFile(wb, filename);

            let message = `‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${exportedCount} —Ç–∞–±–ª–∏—Ü –≤ Excel!`;
            if (skippedCount > 0) {
                message += ` (${skippedCount} –ø—Ä–æ–ø—É—â–µ–Ω–æ)`;
            }
            showToast(message);
        }

        // === –≠–∫—Å–ø–æ—Ä—Ç –í–°–ï–ì–û –æ—Ç—á—ë—Ç–∞ –≤ –æ–¥–∏–Ω CSV —Ñ–∞–π–ª ===
        function exportAllToCSV() {
            let allContent = '';
            let exportedCount = 0;

            const tables = [
                { id: 'revenue-table', title: '–§–ò–ù–ê–ù–°–û–í–´–ô –û–¢–ß–Å–¢' },
                { id: 'deficit-table', title: '–ó–ê–¢–†–ê–¢–´ –ù–ê –ó–ê–ö–£–ü–ö–£ –ü–†–û–î–£–ö–¢–û–í' },
                { id: 'usage-table', title: '–§–ê–ö–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ü–†–û–î–£–ö–¢–û–í' },
                { id: 'planvsfact-table', title: '–ü–õ–ê–ù VS –§–ê–ö–¢ –ü–û –ü–†–û–î–£–ö–¢–ê–ú' },
                { id: 'attendance-table', title: '–ü–û–°–ï–©–ê–ï–ú–û–°–¢–¨' },
                { id: 'writeoffs-table', title: '–†–£–ß–ù–´–ï –°–ü–ò–°–ê–ù–ò–Ø' }
            ];

            tables.forEach(tableInfo => {
                const table = document.getElementById(tableInfo.id);
                if (table && table.querySelector('tbody tr')) {
                    allContent += `\n===== ${tableInfo.title} =====\n\n`;
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cols = row.querySelectorAll('th, td');
                        const rowData = Array.from(cols).map(col => {
                            let text = col.innerText.trim().replace(/\n/g, ' ');
                            if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                                text = '"' + text.replace(/"/g, '""') + '"';
                            }
                            return text;
                        });
                        allContent += rowData.join(',') + '\n';
                    });
                    exportedCount++;
                }
            });

            if (!allContent || exportedCount === 0) {
                showToast('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!');
                return;
            }

            const blob = new Blob(['\ufeff' + allContent], {
                type: 'text/csv;charset=utf-8;'
            });

            const dateStr = new Date().toISOString().slice(0, 10);
            const period = '{{ start_date }}_{{ end_date }}'.replace(/[^a-zA-Z0-9_-]/g, '_');
            const filename = `–ü–æ–ª–Ω—ã–π_–æ—Ç—á—ë—Ç_${period}_${dateStr}.csv`;

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            showToast(`‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${exportedCount} —Ç–∞–±–ª–∏—Ü –≤ CSV!`);
        }

        // === –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ===
        function showToast(message) {
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                `;
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeft = `4px solid ${message.includes('‚úÖ') ? '#28a745' : message.includes('‚ùå') ? '#dc3545' : '#6c757d'}`;
            toast.innerHTML = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => {
                    toast.remove();
                    if (toastContainer.children.length === 0) {
                        toastContainer.remove();
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>