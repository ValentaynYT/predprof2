{% extends "base.html" %}
{% block title %}–ö–∞–±–∏–Ω–µ—Ç —É—á–µ–Ω–∏–∫–∞{% endblock %}
{% block header_title %}üçΩÔ∏è –ö–∞–±–∏–Ω–µ—Ç —É—á–µ–Ω–∏–∫–∞{% endblock %}
{% block extra_css %}
<style>
/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
.student-layout {
    display: flex;
    gap: 30px;
    margin-bottom: 20px;
}
.sidebar-menu {
    width: 250px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
    flex-shrink: 0;
}
.menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 8px;
    font-weight: 500;
    color: #495057;
    border-left: 3px solid transparent;
}
.menu-item:hover {
    background: #f8f9ff;
    color: #4361ee;
}
.menu-item.active {
    background: #e8f4ff;
    color: #4361ee;
    border-left-color: #4361ee;
    box-shadow: 0 2px 8px rgba(67, 97, 238, 0.1);
}
.menu-item i {
    font-size: 1.2rem;
    min-width: 24px;
    text-align: center;
}
/* –ö–æ–Ω—Ç–µ–Ω—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å */
.content-area {
    flex: 1;
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}
.content-section {
    display: none;
}
.content-section.active {
    display: block;
    animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* –ë–∞–ª–∞–Ω—Å –≤–≤–µ—Ä—Ö—É */
.balance-banner {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 24px;
    box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
}
.balance-banner h3 {
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}
.balance-amount {
    font-size: 2rem;
    font-weight: bold;
    margin-top: 8px;
}
/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
.day-section {
    display: none;
}
.day-section.active {
    display: block;
}
.meal-item {
    margin-bottom: 20px;
    padding: 12px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: #fafafa;
}
.meal-header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    margin-bottom: 8px;
}
.status-badge {
    font-size: 0.85rem;
    padding: 2px 8px;
    border-radius: 4px;
    margin-left: 8px;
}
.status-paid { background: #e8f5e9; color: #2e7d32; }
.status-consumed { background: #fff8e1; color: #ff8f00; }
.review-form { margin-top: 8px; }
/* –¢–∞–±—ã –¥–ª—è –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ */
.tabs {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}
.tab-btn {
    padding: 8px 12px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    color: #495057;
    transition: all 0.2s;
    text-align: center;
    white-space: nowrap;
}
.tab-btn:hover {
    background: #e9ecef;
    border-color: #4361ee;
    color: #4361ee;
}
.tab-btn.active {
    background: #4361ee;
    color: white;
    border-color: #4361ee;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(67, 97, 238, 0.2);
}
.tab-btn.today-tab {
    background: #ff9800;
    color: white;
    border-color: #ff9800;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(255, 152, 0, 0.2);
    position: relative;
}
.tab-btn.today-tab::after {
    content: '‚Ä¢';
    position: absolute;
    top: -6px;
    right: 4px;
    font-size: 1.2rem;
    color: #fff;
    animation: blink 1s ease-in-out infinite;
}
@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
.tab-btn.weekend {
    background: #ffebee;
    color: #e74c3c;
    border-color: #e74c3c;
}
/* –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤—ã–±–æ—Ä–∞ –Ω–µ–¥–µ–ª–∏ */
.week-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 24px;
}
.month-nav {
    display: flex;
    align-items: center;
    gap: 8px;
}
.month-btn {
    padding: 8px 12px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 1.1rem;
    color: #495057;
    transition: all 0.2s;
    min-width: 36px;
    text-align: center;
}
.month-btn:hover {
    background: #e9ecef;
    border-color: #4361ee;
    color: #4361ee;
}
.month-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.dropdown-week {
    position: relative;
    display: inline-block;
}
.dropdown-toggle {
    cursor: pointer;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px 12px;
    font-weight: 500;
    color: #495057;
    text-align: center;
    min-width: 200px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.dropdown-toggle::after {
    content: '‚ñº';
    font-size: 0.7rem;
    margin-left: 8px;
}
.dropdown-content {
    display: none;
    position: absolute;
    background-color: #fff;
    min-width: 300px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    z-index: 100;
    border-radius: 8px;
    padding: 10px;
    top: 100%;
    left: 0;
    margin-top: 6px;
    max-height: 400px;
    overflow-y: auto;
}
.dropdown:hover .dropdown-content,
.dropdown-week:hover .dropdown-content {
    display: block;
}
.week-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.week-item {
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.week-item:hover {
    background-color: #f1f1f1;
}
.week-item.active {
    background-color: #e8f4ff;
    font-weight: bold;
    border-left: 3px solid #4361ee;
}
.week-item.weekend {
    color: #e74c3c;
    font-weight: bold;
}
.week-item.today {
    font-weight: bold;
    border-left: 3px solid #ff9800;
    background: #fff8e1;
}
/* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ—Å—è—Ü–µ–≤ */
.month-label {
    font-weight: bold;
    font-size: 1.1rem;
    color: #2c3e50;
    min-width: 120px;
    text-align: center;
}
/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ */
.month-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}
/* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω–µ–π –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ */
.weekend-date {
    color: #e74c3c;
    font-weight: bold;
}
/* –ü–ª–∞—Ç—ë–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ */
.payment-card select {
    width: 100%;
    padding: 8px;
    margin: 6px 0;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}
.card h2, .card h3 {
    margin-top: 0;
    color: #2c3e50;
}
/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-top: 16px;
}
.stat-card {
    background: #f8f9ff;
    padding: 16px;
    border-radius: 8px;
    text-align: center;
    border-left: 4px solid #4361ee;
}
.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2b2d42;
    margin: 8px 0;
}
.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
}
/* –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
.personal-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 16px;
}
.info-item {
    background: #f8f9ff;
    padding: 12px;
    border-radius: 8px;
    border-left: 3px solid #4361ee;
}
.info-label {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 4px;
}
.info-value {
    font-weight: 600;
    color: #2b2d42;
}
/* Flash-—Å–æ–æ–±—â–µ–Ω–∏—è */
.flash-message {
    padding: 12px;
    margin-bottom: 20px;
    border-radius: 8px;
    font-weight: bold;
    color: white;
}
.flash-success { background: #2ecc71; }
.flash-error { background: #e74c3c; }
.flash-info { background: #3498db; }
.flash-warning { background: #f39c12; }
/* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω–µ–π */
.tab-btn.weekend {
    background: #ffebee;
    color: #e74c3c;
    border-color: #e74c3c;
    font-weight: 600;
}

.tab-btn.weekend.today-tab {
    background: #ff6b6b;
    color: white;
    border-color: #ff6b6b;
}

.day-section.weekend-section {
    background: #fff5f5;
    border-left: 4px solid #e74c3c;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö –¥–Ω–µ–π */
.tab-btn.past-day {
    background: #e0e0e0 !important;
    color: #9e9e9e !important;
    border-color: #bdbdbd !important;
    opacity: 0.7;
    font-style: italic;
}
.tab-btn.past-day.weekend {
    /* –î–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Ä—ã–π —Ñ–æ–Ω, –Ω–æ —Ç–µ–∫—Å—Ç –¥–µ–ª–∞–µ–º —Ç–µ–º–Ω–µ–µ */
    color: #757575 !important;
}
.tab-btn.past-day.today-tab {
    /* –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å —Å–ª—É—á–∞–π–Ω–æ —Å—Ç–∞–ª –ø—Ä–æ—à–µ–¥—à–∏–º (–Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å), —É–±–∏—Ä–∞–µ–º –æ—Ä–∞–Ω–∂–µ–≤—ã–π */
    background: #e0e0e0 !important;
    color: #9e9e9e !important;
    border-color: #bdbdbd !important;
    box-shadow: none !important;
}
.tab-btn.past-day::after {
    /* –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "—Å–µ–≥–æ–¥–Ω—è" –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö –¥–Ω–µ–π */
    display: none !important;
}
/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Å—Ç–∞–≤–∞ –±–ª—é–¥ */
.meal-ingredients {
    background: #f8f9ff;
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    font-size: 0.95rem;
}
.meal-ingredients ul {
    margin: 8px 0 0 18px;
    padding-left: 0;
    list-style-type: none;
}
.meal-ingredients li {
    margin-bottom: 4px;
    line-height: 1.4;
}
.meal-ingredients li span {
    color: #6c757d;
    font-size: 0.9em;
}
</style>
{% endblock %}
{% block content %}
<!-- üì¢ FLASH-–°–û–û–ë–©–ï–ù–ò–Ø -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="flash-message flash-{{ category if category in ['success', 'error'] else 'info' }}">
    {{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}
<!-- –ë–∞–ª–∞–Ω—Å –≤–≤–µ—Ä—Ö—É -->
<div class="balance-banner">
    <h3>üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å</h3>
    <div class="balance-amount">{{ "%.2f"|format(current_balance) }} ‚ÇΩ</div>
</div>
<div class="student-layout">
    <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
    <div class="sidebar-menu">
        <div class="menu-item active" data-section="personal-info">
            <span>üë§</span>
            <span>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
        </div>
        <div class="menu-item" data-section="menu-week">
            <span>üìã</span>
            <span>–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</span>
        </div>
        <div class="menu-item" data-section="food-order">
            <span>üí≥</span>
            <span>–ó–∞–∫–∞–∑ –ø–∏—Ç–∞–Ω–∏—è</span>
        </div>
        <div class="menu-item" data-section="preferences">
            <span>‚ö†Ô∏è</span>
            <span>–ü–∏—â–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</span>
        </div>
        <div class="menu-item" data-section="wallet">
            <span>‚ûï</span>
            <span>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</span>
        </div>
    </div>
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
    <div class="content-area">
        <!-- –õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div id="personal-info" class="content-section active">
            <h2>üë§ –õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="position: relative; display: inline-block;">
                    <img
                        src="{{ url_for('static', filename='avatars/' + current_user.avatar_filename) }}"
                        alt="–ê–≤–∞—Ç–∞—Ä–∫–∞"
                        id="avatar-preview"
                        style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #4361ee; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"
                    >
                    <label for="avatar-input" style="position: absolute; bottom: 0; right: 0; background: #4361ee; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
                        ‚úèÔ∏è
                        <input type="file" id="avatar-input" name="avatar" accept="image/*" style="display: none;">
                    </label>
                </div>
                <p style="margin-top: 12px; color: #6c757d; font-size: 0.9rem;">
                    –ù–∞–∂–º–∏—Ç–µ –Ω–∞ ‚úèÔ∏è —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É
                </p>
                <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–∫—Ä—ã—Ç–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS) -->
                <form id="avatar-upload-form" method="post" action="/upload_avatar" enctype="multipart/form-data" style="display: none;">
                    <input type="file" name="avatar" id="avatar-file-input" accept="image/*">
                </form>
            </div>
            <div class="personal-info-grid">
                <div class="info-item">
                    <div class="info-label">–§–ò–û</div>
                    <div class="info-value">{{ current_user.full_name }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ö–ª–∞—Å—Å</div>
                    <div class="info-value">{{ current_user.class_name }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ current_user.email }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                    <div class="info-value">
                        {% if current_user.timestamp %}
                            {{ current_user.timestamp.strftime('%d.%m.%Y') }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </div>
                </div>
            </div>
            <p style="margin-top: 24px; padding: 16px; background: #f8f9ff; border-radius: 8px; border-left: 4px solid #4361ee;">
                <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã.
            </p>
        </div>
        <!-- –ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é -->
        <div id="menu-week" class="content-section">
            <h2>üìã –ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</h2>

            <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤—ã–±–æ—Ä–∞ –Ω–µ–¥–µ–ª–∏ –∏ –º–µ—Å—è—Ü–∞ -->
            <div class="week-selector">
                <div class="month-selector">
                    <button id="prevMonth" class="month-btn">&lt;</button>
                    <div class="month-label" id="currentMonthLabel">–Ø–Ω–≤–∞—Ä—å 2026</div>
                    <button id="nextMonth" class="month-btn">&gt;</button>
                </div>
                <div class="dropdown-week">
                    <div class="dropdown-toggle" id="weekDropdownToggle">
                        <span id="currentWeekRange">26 —è–Ω–≤ - 01 —Ñ–µ–≤</span>
                    </div>
                    <div class="dropdown-content" id="weekDropdownContent">
                        <div class="week-list" id="weekList">
                            <!-- –°–ø–∏—Å–æ–∫ –Ω–µ–¥–µ–ª—å –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢–∞–±—ã –¥–ª—è –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ -->
            <div class="tabs" id="weekTabs">
                <button id="prevWeek" class="tab-btn">&lt;</button>
                {% for day in days %}
                    {% set is_weekend = day in ['saturday', 'sunday'] %}
                    <button
                        class="tab-btn {% if loop.first %}active{% endif %} {% if day == current_day %}today-tab{% endif %} {% if is_weekend %}weekend{% endif %}"
                        data-day="{{ day }}"
                        {% if is_weekend %}data-weekend="true"{% endif %}
                    >
                        {% if day == 'monday' %}–ü–Ω
                        {% elif day == 'tuesday' %}–í—Ç
                        {% elif day == 'wednesday' %}–°—Ä
                        {% elif day == 'thursday' %}–ß—Ç
                        {% elif day == 'friday' %}–ü—Ç
                        {% elif day == 'saturday' %}–°–±
                        {% elif day == 'sunday' %}–í—Å{% endif %}
                        <span class="day-date">{{ day_dates[day].day }}</span>
                    </button>
                {% endfor %}
                <button id="nextWeek" class="tab-btn">&gt;</button>
            </div>

            <!-- –°–µ–∫—Ü–∏–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ -->
            {% for day in days %}
            {% set is_weekend = day in ['saturday', 'sunday'] %}
            <div class="day-section {% if loop.first %}active{% endif %} {% if is_weekend %}weekend-section{% endif %}" id="day-{{ day }}">
                {% if is_weekend %}
                    <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 8px; margin-bottom: 16px;">
                        <h3 style="color: #e74c3c; margin: 0;">
                            <span style="font-size: 2rem;">üèñÔ∏è</span><br>
                            –í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å
                        </h3>
                        <p style="color: #7f8c8d; margin-top: 8px;">
                            –í —Å—Ç–æ–ª–æ–≤–æ–π –≤—ã—Ö–æ–¥–Ω–æ–π. –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞!
                        </p>
                    </div>
                {% else %}
                    {% for meal_type, meal in meals[day].items() %}
                        {% if meal %}
                            <div class="meal-item">
                                <div class="meal-header">
                                    <span>
                                        {{ "üïó –ó–∞–≤—Ç—Ä–∞–∫" if meal_type == "breakfast" else "üïê –û–±–µ–¥" }}
                                        <span class="status-badge" style="display: none;"></span>
                                    </span>
                                    <span>{{ meal.price }} ‚ÇΩ</span>
                                </div>

                                <!-- –ù–ê–ó–í–ê–ù–ò–ï –ë–õ–Æ–î–ê -->
                                <p style="font-weight: 600; font-size: 1.1rem; margin: 8px 0;">{{ meal.name }}</p>

                                <!-- –°–û–°–¢–ê–í –ë–õ–Æ–î–ê (–ò–ù–ì–†–ï–î–ò–ï–ù–¢–´) -->
                                {% if meal.ingredients and meal.ingredients|length > 0 %}
                                    <div style="background: #f8f9ff; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 0.95rem;">
                                        <strong>üìã –°–æ—Å—Ç–∞–≤:</strong>
                                        <ul style="margin: 8px 0 0 18px; padding-left: 0; list-style-type: none;">
                                            {% for ing in meal.ingredients %}
                                                <li style="margin-bottom: 4px; line-height: 1.4;">
                                                    ‚Ä¢ {{ ing.name }}
                                                    {% if ing.quantity %}
                                                        <span style="color: #6c757d; font-size: 0.9em;">({{ "%.1f"|format(ing.quantity) if ing.quantity % 1 != 0 else ing.quantity }} {{ ing.unit }})</span>
                                                    {% endif %}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}

                                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –±—É–¥—É—â–∏—Ö –¥–Ω–µ–π –≤–º–µ—Å—Ç–æ —Ñ–æ—Ä–º—ã -->
                                <div class="future-review-message" style="display: none; background: #e8f5e9; padding: 12px; border-radius: 8px; margin-top: 10px; text-align: center; color: #2e7d32; font-weight: 500;">
                                    üìÖ –û—Ç–∑—ã–≤ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–Ω—è
                                </div>

                                <!-- –°–¢–ê–¢–£–° –ó–ê–ö–ê–ó–ê –ò –°–û–û–ë–©–ï–ù–ò–Ø -->
                                {% set order_key = day + '_' + meal_type + '_0' %}
                                {% set order_data = order_status.get(order_key, {}) %}

                                <!-- === –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ-–¥—Ä—É–≥–æ–º—É === -->
                                {% if order_data and order_data.get('consumed', False) and order_data.get('student_confirmed', False) %}
                                    <!-- –ü–∏—Ç–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –æ—Ç–∑—ã–≤–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã -->
                                    <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-top: 10px; text-align: center; color: #2e7d32; font-weight: 500;">
                                        ‚úÖ <strong>–ü–∏—Ç–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</strong>
                                    </div>

                                    <!-- –§–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞ -->
                                    <form method="post" action="/submit_review" class="review-form" data-day="{{ day }}" data-meal-type="{{ meal_type }}">
                                        <input type="hidden" name="day" value="{{ day }}">
                                        <input type="hidden" name="meal_type" value="{{ meal_type }}">
                                        <input type="hidden" name="week_offset" value="0">
                                        <textarea name="text" placeholder="–í–∞—à –æ—Ç–∑—ã–≤..." style="height: 60px;">{{ user_reviews.get((day, meal_type), '') }}</textarea>
                                        <button type="submit" class="btn-review" style="width: auto; margin-top: 6px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                                    </form>

                                {% elif order_data and order_data.get('consumed', False) and not order_data.get('student_confirmed', False) %}
                                    <!-- –ü–æ–≤–∞—Ä –≤—ã–¥–∞–ª, –Ω–æ —É—á–µ–Ω–∏–∫ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª -->
                                    <div style="background: #fff3cd; padding: 16px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ffc107;">
                                        <strong style="color: #856404;">‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ</strong>
                                        <p style="margin: 8px 0 0 0; font-size: 0.9rem; color: #856404;">
                                            –ü–æ–≤–∞—Ä –≤—ã–¥–∞–ª –≤–∞–º –ø–∏—Ç–∞–Ω–∏–µ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ.
                                        </p>
                                        <form method="post" action="/student/confirm_consumption/{{ order_data.get('order_id', 0) }}" style="margin-top: 12px;">
                                            <button type="submit" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
                                                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ
                                            </button>
                                        </form>
                                    </div>

                                {% elif order_data and order_data.get('paid', False) and not order_data.get('consumed', False) %}
                                    <!-- –ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω, –Ω–æ –µ—â—ë –Ω–µ –≤—ã–¥–∞–Ω -->
                                    <div style="background: #f8d7da; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 3px solid #dc3545;">
                                        <strong style="color: #721c24;">üîí –ü–∏—Ç–∞–Ω–∏–µ –µ—â—ë –Ω–µ –≤—ã–¥–∞–Ω–æ</strong>
                                        <p style="margin: 8px 0 0 0; font-size: 0.9rem; color: #721c24;">
                                            –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ø–æ–≤–∞—Ä—É –≤ —Å—Ç–æ–ª–æ–≤–æ–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è.
                                        </p>
                                    </div>

                                {% else %}
                                    <!-- –ó–∞–∫–∞–∑ –Ω–µ –æ–ø–ª–∞—á–µ–Ω –∏–ª–∏ –æ—Ç–º–µ–Ω—ë–Ω -->
                                    <div style="background: #f8d7da; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 3px solid #dc3545;">
                                        <strong style="color: #721c24;">üîí –°–Ω–∞—á–∞–ª–∞ –æ–ø–ª–∞—Ç–∏—Ç–µ –ø–∏—Ç–∞–Ω–∏–µ</strong>
                                        <p style="margin: 8px 0 0 0; font-size: 0.9rem; color: #721c24;">
                                            –û–ø–ª–∞—Ç–∏—Ç–µ —ç—Ç–æ—Ç –ø—Ä–∏—ë–º –ø–∏—â–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.
                                        </p>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        {% endfor %}
        </div>
        <!-- –ó–∞–∫–∞–∑ –ø–∏—Ç–∞–Ω–∏—è -->
        <div id="food-order" class="content-section">
            <h2>üí≥ –ó–∞–∫–∞–∑ –ø–∏—Ç–∞–Ω–∏—è</h2>

            <!-- –ì–∏–±–∫–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç (–≤ —Å—Ç–∏–ª–µ —Å—Ç–∞—Ä–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞) -->
            <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 24px; border: 1px solid #bee9ff;">
                <h3 style="margin-top: 0;">‚ú® –ì–∏–±–∫–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç</h3>
                <p style="color: #495057; margin-bottom: 16px; line-height: 1.5;">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–Ω–∏ –∏ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏. –ü–ª–∞—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∑–∞ —Ç–æ, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ!
                </p>
                <div style="background: rgba(255, 255, 255, 0.7); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem;">
                        <span>üéØ –ì–∏–±–∫–æ—Å—Ç—å:</span>
                        <strong style="color: #4361ee;">–í—ã–±–∏—Ä–∞–π—Ç–µ —Å–∞–º–∏</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem;">
                        <span>üí∞ –≠–∫–æ–Ω–æ–º–∏—è:</span>
                        <strong style="color: #2ecc71;">–¢–æ–ª—å–∫–æ –∑–∞ –Ω—É–∂–Ω–æ–µ</strong>
                    </div>
                </div>
                <a href="/student/subscription/flexible" class="btn-save"
                   style="background: #2ecc71; color: white; width: 100%; padding: 12px;
                          font-size: 1.1rem; margin-top: 10px; display: block;
                          text-align: center; text-decoration: none; border: none;
                          border-radius: 6px; cursor: pointer; box-sizing: border-box;">
                    ‚ú® –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å
                </a>
            </div>

            <!-- –†–∞–∑–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞ -->
            <div style="background: #fff8e1; padding: 20px; border-radius: 10px; border: 1px solid #ffd54f;">
                <h3 style="margin-top: 0;">üçΩÔ∏è –†–∞–∑–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 0.95rem;">
                    –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –≤—Å–µ–≥–æ –æ–¥–∏–Ω –ø—Ä–∏—ë–º –ø–∏—â–∏
                </p>
                <form method="post" action="/pay" id="single-pay-form">
                    <input type="hidden" name="type" value="single">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">üìÖ –î–µ–Ω—å:</label>
                    <select name="day" required id="pay-day-select" style="width: 100%; padding: 10px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 6px;">
                        {% for item in available_payment_days %}
                        <option value="{{ item.value }}">{{ item.display }}</option>
                        {% endfor %}
                    </select>
                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">üïó –ü—Ä–∏—ë–º –ø–∏—â–∏:</label>
                    <select name="meal_type" required id="pay-meal-select" style="width: 100%; padding: 10px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="breakfast" data-price="{{ meals['monday']['breakfast'].price if meals['monday']['breakfast'] else 0 }}">üïó –ó–∞–≤—Ç—Ä–∞–∫ ({{ meals['monday']['breakfast'].price if meals['monday']['breakfast'] else '0' }} ‚ÇΩ)</option>
                        <option value="lunch" data-price="{{ meals['monday']['lunch'].price if meals['monday']['lunch'] else 0 }}">üïê –û–±–µ–¥ ({{ meals['monday']['lunch'].price if meals['monday']['lunch'] else '0' }} ‚ÇΩ)</option>
                    </select>
                    <button type="submit" class="btn-save" style="background: #e67e22; width: 100%; padding: 12px; font-size: 1.1rem; margin-top: 10px;" id="single-pay-btn">
                        üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Ä–∞–∑–æ–≤–æ
                    </button>
                </form>
            </div>
        </div>
        <!-- –ü–∏—â–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ -->
        <div id="preferences" class="content-section">
            <h2>‚ö†Ô∏è –ü–∏—â–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">
                –£–∫–∞–∂–∏—Ç–µ –∞–ª–ª–µ—Ä–≥–∏–∏, –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç–∏ –∏–ª–∏ –¥—Ä—É–≥–∏–µ –ø–∏—â–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è. –≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–≤–∞—Ä—É.
            </p>
            <form method="post">
                <textarea
                    name="allergy"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∞–ª–ª–µ—Ä–≥–∏—è –Ω–∞ –º–æ–ª–æ–∫–æ, –±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞, –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –æ—Ä–µ—Ö–æ–≤, –≤–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –∏ —Ç.–¥."
                    style="width: 100%; height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 16px;"
                >{{ current_allergy }}</textarea>
                <button type="submit" class="btn-save" style="width: 100%; padding: 12px; font-size: 1.1rem;">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </form>
            {% if current_allergy %}
                <div style="margin-top: 20px; padding: 16px; background: #fff8e1; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <strong>–¢–µ–∫—É—â–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</strong>
                    <p style="margin: 8px 0 0 0;">{{ current_allergy }}</p>
                </div>
            {% endif %}
        </div>
        <!-- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ -->
        <div id="wallet" class="content-section">
            <h2>üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</h2>
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 24px;">
                <h3 style="margin-top: 0; color: #1976d2;">üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</h3>
                <div style="font-size: 2rem; font-weight: bold; color: #1976d2;">
                    {{ "%.2f"|format(current_balance) }} ‚ÇΩ
                </div>
            </div>
            <form method="post" action="/topup">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                    –°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (‚ÇΩ):
                </label>
                <input
                    type="number"
                    name="amount"
                    min="10"
                    max="10000"
                    step="10"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ—Ç 10 –¥–æ 10000 ‚ÇΩ"
                    required
                    style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; margin-bottom: 16px;"
                >
                <button type="submit" class="btn-save" style="background: #3498db; width: 100%; padding: 14px; font-size: 1.2rem;">
                    ‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
                </button>
            </form>
            <p style="font-size: 0.9rem; color: #666; margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                ‚ö†Ô∏è –≠—Ç–æ –∏–º–∏—Ç–∞—Ü–∏—è. –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –ø–ª–∞—Ç—ë–∂–Ω—ã–π —à–ª—é–∑ (–°–ë–ü, –±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏).
            </p>
            <div style="margin-top: 24px; padding: 16px; background: #f8f9ff; border-radius: 8px;">
                <h4 style="margin-top: 0;">üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Å—É–º–º—ã:</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px;">
                    <button type="button" onclick="document.querySelector('[name=amount]').value='500'" style="padding: 8px; background: #e0e0ff; border: none; border-radius: 6px; cursor: pointer;">500 ‚ÇΩ</button>
                    <button type="button" onclick="document.querySelector('[name=amount]').value='1000'" style="padding: 8px; background: #e0e0ff; border: none; border-radius: 6px; cursor: pointer;">1000 ‚ÇΩ</button>
                    <button type="button" onclick="document.querySelector('[name=amount]').value='2000'" style="padding: 8px; background: #e0e0ff; border: none; border-radius: 6px; cursor: pointer;">2000 ‚ÇΩ</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
// ========================================
// –í–´–ü–ê–î–ê–Æ–©–ò–ô –°–ü–ò–°–û–ö –í–´–ë–û–†–ê –ù–ï–î–ï–õ–ò –ò –ú–ï–°–Ø–¶–ê
// ========================================
let currentWeekOffset = 0; // –°–º–µ—â–µ–Ω–∏–µ –æ—Ç —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö –Ω–µ–¥–µ–ª—å)
const MAX_WEEKS_AHEAD = 52;  // 52 –Ω–µ–¥–µ–ª–∏ –≤–ø–µ—Ä—ë–¥ (–≤–µ—Å—å –≥–æ–¥)
const MAX_WEEKS_BACK = 52;   // 52 –Ω–µ–¥–µ–ª–∏ –Ω–∞–∑–∞–¥ (–≤–µ—Å—å –≥–æ–¥)
let currentMonthIndex = new Date().getMonth(); // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü (0-11)
const currentYear = new Date().getFullYear();
const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
const prevMonthBtn = document.getElementById('prevMonth');
const nextMonthBtn = document.getElementById('nextMonth');
const currentMonthLabel = document.getElementById('currentMonthLabel');
const weekDropdownToggle = document.getElementById('weekDropdownToggle');
const weekDropdownContent = document.getElementById('weekDropdownContent');
const weekList = document.getElementById('weekList');
const prevWeekBtn = document.getElementById('prevWeek');
const nextWeekBtn = document.getElementById('nextWeek');

// ========================================
// –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ü–ò–°–ö–ê –ù–ï–î–ï–õ–¨ –î–õ–Ø –¢–ï–ö–£–©–ï–ì–û –ì–û–î–ê
// ========================================
function generateWeeksForYear(year) {
    const weeks = [];
    let currentDate = new Date(year, 0, 1);

    // –ù–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≥–æ–¥–∞
    while (currentDate.getDay() !== 1) {
        currentDate.setDate(currentDate.getDate() + 1);
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–µ–¥–µ–ª–∏
    while (currentDate.getFullYear() === year) {
        const weekStart = new Date(currentDate);
        const weekEnd = new Date(currentDate);
        weekEnd.setDate(weekEnd.getDate() + 6);

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
        const startDateStr = formatDate(weekStart);
        const endDateStr = formatDate(weekEnd);

        weeks.push({
            start: weekStart,
            end: weekEnd,
            startDateStr: startDateStr,
            endDateStr: endDateStr,
            month: weekStart.getMonth(),
            year: weekStart.getFullYear(),
            isCurrentWeek: isCurrentWeek(weekStart, weekEnd)
        });

        currentDate.setDate(currentDate.getDate() + 7);
    }

    return weeks;
}

function formatDate(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞—è', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'][date.getMonth()];
    return `${day} ${month}`;
}

function isCurrentWeek(start, end) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    start.setHours(0, 0, 0, 0);
    end.setHours(23, 59, 59, 999);
    return today >= start && today <= end;
}

// ========================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –í–´–ü–ê–î–ê–Æ–©–ï–ì–û –°–ü–ò–°–ö–ê –ù–ï–î–ï–õ–¨
// ========================================
function updateWeekDropdown() {
    const weeks = generateWeeksForYear(currentYear);

    // –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–¥–µ–ª–∏ –ø–æ —Ç–µ–∫—É—â–µ–º—É –º–µ—Å—è—Ü—É
    const filteredWeeks = weeks.filter(week => week.month === currentMonthIndex);

    weekList.innerHTML = '';

    filteredWeeks.forEach((week, index) => {
        const weekItem = document.createElement('div');
        weekItem.className = 'week-item';

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –Ω–µ–¥–µ–ª—è –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏
        const hasWeekend = weekContainsWeekend(week.start, week.end);
        if (hasWeekend) {
            weekItem.classList.add('weekend');
        }

        if (week.isCurrentWeek) {
            weekItem.classList.add('today');
        }

        weekItem.innerHTML = `
            <span>${week.startDateStr} - ${week.endDateStr}</span>
            <span style="color: #666; font-size: 0.85rem;">${monthNames[week.month]}</span>
        `;

        weekItem.addEventListener('click', function() {
            // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π
            const currentWeekStart = getCurrentWeekStart();
            const diffDays = Math.floor((week.start - currentWeekStart) / (1000 * 60 * 60 * 24));
            const weekOffset = Math.floor(diffDays / 7);

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö –Ω–µ–¥–µ–ª—å)
            currentWeekOffset = weekOffset;

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            currentWeekOffset = Math.max(-MAX_WEEKS_BACK, Math.min(MAX_WEEKS_AHEAD, currentWeekOffset));

            updateWeekDisplay();
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
            weekDropdownContent.style.display = 'none';
        });

        weekList.appendChild(weekItem);
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
    updateCurrentWeekRangeDisplay();
}

function weekContainsWeekend(start, end) {
    let date = new Date(start);
    while (date <= end) {
        if (date.getDay() === 0 || date.getDay() === 6) { // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –∏–ª–∏ —Å—É–±–±–æ—Ç–∞
            return true;
        }
        date.setDate(date.getDate() + 1);
    }
    return false;
}

function getCurrentWeekStart() {
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 (–≤—Å) - 6 (—Å–±)
    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
    const monday = new Date(today.setDate(diff));
    monday.setHours(0, 0, 0, 0);
    return monday;
}

// ========================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –¢–ï–ö–£–©–ï–ì–û –î–ò–ê–ü–ê–ó–û–ù–ê –î–ê–¢
// ========================================
function updateCurrentWeekRangeDisplay() {
    const today = new Date();
    const startOfWeek = new Date(today);
    const diff = today.getDate() - ((today.getDay() + 6) % 7);
    startOfWeek.setDate(diff + currentWeekOffset * 7);

    const weekEnd = new Date(startOfWeek);
    weekEnd.setDate(weekEnd.getDate() + 6);

    const startDateStr = formatDate(startOfWeek);
    const endDateStr = formatDate(weekEnd);

    document.getElementById('currentWeekRange').textContent = `${startDateStr} - ${endDateStr}`;
    currentMonthLabel.textContent = `${monthNames[currentMonthIndex]} ${currentYear}`;
}

// ========================================
// –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ù–ï–î–ï–õ–¨ (–≤–µ—Å—å –≥–æ–¥ –≤–ø–µ—Ä—ë–¥ –∏ –Ω–∞–∑–∞–¥)
// ========================================
if (prevWeekBtn && nextWeekBtn) {
    prevWeekBtn.addEventListener('click', function() {
        if (currentWeekOffset > -MAX_WEEKS_BACK) {
            currentWeekOffset--;
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–µ—Å—è—Ü –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ç–µ–∫—É—â–µ–≥–æ
            const today = new Date();
            const startOfWeek = new Date(today);
            const diff = today.getDate() - ((today.getDay() + 6) % 7);
            startOfWeek.setDate(diff + currentWeekOffset * 7);
            const newMonth = startOfWeek.getMonth();
            if (newMonth !== currentMonthIndex) {
                currentMonthIndex = newMonth;
                updateWeekDropdown();
            }
            updateWeekDisplay();
        }
    });

    nextWeekBtn.addEventListener('click', function() {
        if (currentWeekOffset < MAX_WEEKS_AHEAD) {
            currentWeekOffset++;
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–µ—Å—è—Ü –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ç–µ–∫—É—â–µ–≥–æ
            const today = new Date();
            const startOfWeek = new Date(today);
            const diff = today.getDate() - ((today.getDay() + 6) % 7);
            startOfWeek.setDate(diff + currentWeekOffset * 7);
            const newMonth = startOfWeek.getMonth();
            if (newMonth !== currentMonthIndex) {
                currentMonthIndex = newMonth;
                updateWeekDropdown();
            }
            updateWeekDisplay();
        }
    });
}

// ========================================
// –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ú–ï–°–Ø–¶–ï–í
// ========================================
if (prevMonthBtn && nextMonthBtn) {
    prevMonthBtn.addEventListener('click', function() {
        if (currentMonthIndex > 0) {
            currentMonthIndex--;
            updateWeekDropdown();
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –º–µ—Å—è—Ü–∞
            currentWeekOffset = 0;
            updateWeekDisplay();
        }
    });

    nextMonthBtn.addEventListener('click', function() {
        if (currentMonthIndex < 11) {
            currentMonthIndex++;
            updateWeekDropdown();
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –º–µ—Å—è—Ü–∞
            currentWeekOffset = 0;
            updateWeekDisplay();
        }
    });
}

// ========================================
// –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–´–ü–ê–î–ê–Æ–©–ï–ì–û –°–ü–ò–°–ö–ê
// ========================================
weekDropdownToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    if (weekDropdownContent.style.display === 'block') {
        weekDropdownContent.style.display = 'none';
    } else {
        weekDropdownContent.style.display = 'block';
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('click', function(e) {
    if (!weekDropdownToggle.contains(e.target) && !weekDropdownContent.contains(e.target)) {
        weekDropdownContent.style.display = 'none';
    }
});

// ========================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –ù–û–ú–ï–†–ê –ù–ï–î–ï–õ–ò –í –§–û–†–ú–ê–• –û–¢–ó–´–í–û–í –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –¢–ï–ö–°–¢–ê
// ========================================
function updateReviewWeekOffsets() {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Å –Ω–æ–º–µ—Ä–æ–º –Ω–µ–¥–µ–ª–∏ –≤–æ –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ö –æ—Ç–∑—ã–≤–æ–≤
    document.querySelectorAll('input[name="week_offset"]').forEach(input => {
        input.value = currentWeekOffset;
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
    updateReviewsDisplay();
}

function updateReviewsDisplay() {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ—Ç–∑—ã–≤—ã –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞ (—Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∫–ª—é—á–∏)
    const allReviews = {{ user_reviews_all | tojson }};

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ—Ä–º—ã
    document.querySelectorAll('.review-form').forEach(form => {
        const dayInput = form.querySelector('input[name="day"]');
        const mealTypeInput = form.querySelector('input[name="meal_type"]');
        const weekOffsetInput = form.querySelector('input[name="week_offset"]');
        const textarea = form.querySelector('textarea[name="text"]');

        if (dayInput && mealTypeInput && weekOffsetInput && textarea) {
            const day = dayInput.value;
            const mealType = mealTypeInput.value;
            const weekOffset = parseInt(weekOffsetInput.value);

            // === –í–´–ß–ò–°–õ–Ø–ï–ú –ê–ë–°–û–õ–Æ–¢–ù–´–ô –ù–û–ú–ï–† –ù–ï–î–ï–õ–ò ===
            const today = new Date();
            const currentWeekStart = new Date(today);
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
            const diff = today.getDate() - ((today.getDay() + 6) % 7);
            currentWeekStart.setDate(diff);

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏
            const reviewWeekStart = new Date(currentWeekStart);
            reviewWeekStart.setDate(currentWeekStart.getDate() + weekOffset * 7);

            // –ü–æ–ª—É—á–∞–µ–º –≥–æ–¥ –∏ –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ ISO
            const isoYear = reviewWeekStart.getFullYear();
            const isoWeek = getISOWeekNumber(reviewWeekStart);

            // === –§–û–†–ú–ò–†–£–ï–ú –ö–õ–Æ–ß –ù–ê –û–°–ù–û–í–ï –ê–ë–°–û–õ–Æ–¢–ù–´–• –ó–ù–ê–ß–ï–ù–ò–ô ===
            const reviewKey = `${day}_${mealType}_${isoYear}_${isoWeek}`;

            // –ò—â–µ–º –æ—Ç–∑—ã–≤ –≤ –¥–∞–Ω–Ω—ã—Ö
            textarea.value = allReviews[reviewKey] || '';
        }
    });
}

// ========================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–û–í –û–¢–ó–´–í–û–í –ü–†–ò –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ò –ù–ï–î–ï–õ–ò
// ========================================
function updateReviewStatuses() {
    const orderStatus = {{ order_status | tojson }};
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const mealTypes = ['breakfast', 'lunch'];

    days.forEach(day => {
        mealTypes.forEach(mealType => {
            const key = `${day}_${mealType}_${currentWeekOffset}`;
            const status = orderStatus[key];
            const reviewMessageDiv = document.querySelector(`#day-${day} .review-status-message`);

            if (!reviewMessageDiv) return;

            const notConsumedDiv = reviewMessageDiv.querySelector('.status-not-consumed');
            const notPaidDiv = reviewMessageDiv.querySelector('.status-not-paid');

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (notConsumedDiv) notConsumedDiv.style.display = 'none';
            if (notPaidDiv) notPaidDiv.style.display = 'none';

            if (status) {
                if (status.paid && status.consumed) {
                    // –û–ø–ª–∞—á–µ–Ω –∏ –ø–æ–ª—É—á–µ–Ω - —Ñ–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞ —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
                    const form = document.querySelector(`#day-${day} form[data-day="${day}"][data-meal-type="${mealType}"]`);
                    if (form) form.style.display = 'block';
                } else if (status.paid && !status.consumed) {
                    // –û–ø–ª–∞—á–µ–Ω, –Ω–æ –Ω–µ –ø–æ–ª—É—á–µ–Ω
                    if (notConsumedDiv) notConsumedDiv.style.display = 'block';
                    if (notPaidDiv) notPaidDiv.style.display = 'none';
                } else {
                    // –ù–µ –æ–ø–ª–∞—á–µ–Ω
                    if (notConsumedDiv) notConsumedDiv.style.display = 'none';
                    if (notPaidDiv) notPaidDiv.style.display = 'block';
                }
            } else {
                // –ó–∞–∫–∞–∑ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (notConsumedDiv) notConsumedDiv.style.display = 'none';
                if (notPaidDiv) notPaidDiv.style.display = 'block';
            }
        });
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –Ω–µ–¥–µ–ª–∏ ISO (1-53)
function getISOWeekNumber(date) {
    const d = new Date(date);
    d.setHours(0, 0, 0, 0);
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞ —á–µ—Ç–≤–µ—Ä–≥ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (–ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É ISO)
    d.setDate(d.getDate() + 4 - (d.getDay() || 7));
    const yearStart = new Date(d.getFullYear(), 0, 1);
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// ========================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–û–°–¢–£–ü–ù–û–°–¢–ò –§–û–†–ú –û–¢–ó–´–í–û–í (–ë–õ–û–ö–ò–†–û–í–ö–ê –ë–£–î–£–©–ò–• –î–ù–ï–ô)
// ========================================
function updateReviewFormsAvailability() {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // –û–±–Ω—É–ª—è–µ–º –≤—Ä–µ–º—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

    // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–µ–¥–µ–ª–∏
    const startOfWeek = new Date();
    const now = new Date();

    // –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –§–û–†–ú–£–õ–ê: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ + —Å–º–µ—â–µ–Ω–∏–µ
    // (day + 6) % 7 –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç: –≤—Å(0)‚Üí–ø–Ω(-6), –ø–Ω(1)‚Üí–ø–Ω(0), –≤—Ç(2)‚Üí–ø–Ω(-1)...
    const diff = now.getDate() - ((now.getDay() + 6) % 7);
    startOfWeek.setDate(diff + currentWeekOffset * 7);

    startOfWeek.setHours(0, 0, 0, 0);

    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    days.forEach((day, index) => {
        // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–Ω—è –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–µ–¥–µ–ª–µ
        const dayDate = new Date(startOfWeek);
        dayDate.setDate(startOfWeek.getDate() + index);
        dayDate.setHours(0, 0, 0, 0);

        // –ù–∞—Ö–æ–¥–∏–º —Å–µ–∫—Ü–∏—é –¥–Ω—è
        const daySection = document.getElementById(`day-${day}`);
        if (!daySection) return;

        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ñ–æ—Ä–º—ã –æ—Ç–∑—ã–≤–æ–≤ –≤ —Å–µ–∫—Ü–∏–∏
        const reviewForms = daySection.querySelectorAll('.review-form');
        reviewForms.forEach(form => {
            const textarea = form.querySelector('textarea[name="text"]');
            const button = form.querySelector('button[type="submit"]');
            const futureMessage = form.querySelector('.future-review-message');

            if (dayDate <= today) {
                // –î–µ–Ω—å –ù–ï –±—É–¥—É—â–∏–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                form.style.display = 'block';
                if (textarea) textarea.disabled = false;
                if (button) button.disabled = false;
                if (futureMessage) futureMessage.style.display = 'none';
            } else {
                // –ë—É–¥—É—â–∏–π –¥–µ–Ω—å - —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                form.style.display = 'none';
                if (futureMessage) futureMessage.style.display = 'block';
            }
        });

        // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ä–º –æ—Ç–∑—ã–≤–æ–≤ (–≤—ã—Ö–æ–¥–Ω–æ–π), –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –±—É–¥—É—â–µ–º –¥–Ω–µ
        const futureMessage = daySection.querySelector('.future-review-message');
        if (futureMessage) {
            if (dayDate <= today) {
                futureMessage.style.display = 'none';
            } else {
                futureMessage.style.display = 'block';
            }
        }
    });
}

// ========================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ù–ï–î–ï–õ–ò (–° –í–´–•–û–î–ù–´–ú–ò –ò –ü–†–û–®–ï–î–®–ò–ú–ò –î–ù–Ø–ú–ò)
// ========================================
function updateWeekDisplay() {
    const today = new Date();
    const startOfWeek = new Date(today);
    // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–µ–¥–µ–ª–∏ (—Å —É—á—ë—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è)
    const diff = today.getDate() - ((today.getDay() + 6) % 7);
    startOfWeek.setDate(diff + currentWeekOffset * 7);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ —É—á–µ–±–Ω–æ–≥–æ –≥–æ–¥–∞ (1 —Å–µ–Ω—Ç—è–±—Ä—è —Ç–µ–∫—É—â–µ–≥–æ –∏–ª–∏ –ø—Ä–æ—à–ª–æ–≥–æ –≥–æ–¥–∞)
    const currentYear = today.getFullYear();
    const septemberFirst = new Date(currentYear, 8, 1); // –ú–µ—Å—è—Ü—ã –≤ JS: 0=—è–Ω–≤, 8=—Å–µ–Ω
    const academicYearStart = (today >= septemberFirst) ? septemberFirst : new Date(currentYear - 1, 8, 1);
    academicYearStart.setHours(0, 0, 0, 0);

    // –û–±–Ω—É–ª—è–µ–º –≤—Ä–µ–º—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è (7 –¥–Ω–µ–π)
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    days.forEach((day, index) => {
        const dayElement = document.querySelector(`.tab-btn[data-day="${day}"]`);
        if (dayElement) {
            const date = new Date(startOfWeek);
            date.setDate(startOfWeek.getDate() + index);

            // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const dateWithoutTime = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–µ–Ω—å –≤—ã—Ö–æ–¥–Ω—ã–º
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –∏–ª–∏ —Å—É–±–±–æ—Ç–∞

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–∞—Ç—ã
            const dateSpan = dayElement.querySelector('.day-date');
            if (dateSpan) {
                dateSpan.textContent = date.getDate();
            }

            // –£–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å–∞–º–∏ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è
            if (isWeekend) {
                dayElement.classList.add('weekend');
            } else {
                dayElement.classList.remove('weekend');
            }

            // === –ü–†–û–í–ï–†–ö–ê –ù–ê –ü–†–û–®–ï–î–®–ò–ô –î–ï–ù–¨ ===
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
            dayElement.classList.remove('past-day');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ –¥–æ –Ω–∞—á–∞–ª–∞ —É—á–µ–±–Ω–æ–≥–æ –≥–æ–¥–∞
            if (dateWithoutTime < academicYearStart) {
                dayElement.classList.add('past-day');
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Å–º–µ—â–µ–Ω–∏—é –Ω–µ–¥–µ–ª–∏
            else if (currentWeekOffset < 0) {
                // –í—Å—è –Ω–µ–¥–µ–ª—è –≤ –ø—Ä–æ—à–ª–æ–º (–¥–æ —Ç–µ–∫—É—â–µ–π)
                dayElement.classList.add('past-day');
            } else if (currentWeekOffset === 0) {
                // –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –¥–∞—Ç–µ
                if (dateWithoutTime < todayWithoutTime) {
                    dayElement.classList.add('past-day');
                }
            }
            // –î–ª—è –±—É–¥—É—â–∏—Ö –Ω–µ–¥–µ–ª—å (currentWeekOffset > 0) –∫–ª–∞—Å—Å –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å (—Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏) - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è
    document.querySelectorAll('.tab-btn[data-day]').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('today-tab');
    });

    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è (—Å–º–µ—â–µ–Ω–∏–µ 0) –∏ –¥–∞—Ç–∞ –Ω–µ —Ä–∞–Ω—å—à–µ –Ω–∞—á–∞–ª–∞ —É—á–µ–±–Ω–æ–≥–æ –≥–æ–¥–∞
    if (currentWeekOffset === 0 && todayWithoutTime >= academicYearStart) {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 6 = —Å—É–±–±–æ—Ç–∞)
        const todayDay = today.getDay();
        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const currentDay = dayNames[todayDay];

        const currentDayBtn = document.querySelector(`.tab-btn[data-day="${currentDay}"]`);
        if (currentDayBtn && !currentDayBtn.classList.contains('past-day')) {
            currentDayBtn.classList.add('active', 'today-tab');
            // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –≤—ã—Ö–æ–¥–Ω–æ–π, –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å–æ–±—ã–π —Å—Ç–∏–ª—å (–Ω–æ –Ω–µ –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö)
            if (currentDay === 'saturday' || currentDay === 'sunday') {
                currentDayBtn.classList.add('weekend');
            }
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –æ–ø–ª–∞—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–¥–µ–ª—å 0-3)
    updatePaymentStatuses();

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
    updateCurrentWeekRangeDisplay();

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–∑—ã–≤—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
    updateReviewWeekOffsets();

    updateReviewFormsAvailability();

    updateReviewStatuses();
}

// ========================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–û–í –û–ü–õ–ê–¢–´ –ü–û –ù–ï–î–ï–õ–Ø–ú (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–¥–µ–ª—å 0-3)
// ========================================
function updatePaymentStatuses() {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã
    document.querySelectorAll('.status-badge').forEach(badge => {
        badge.style.display = 'none';
        badge.classList.remove('status-paid', 'status-consumed');
        badge.textContent = '';
    });

    // –î–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö –Ω–µ–¥–µ–ª—å –∏ –Ω–µ–¥–µ–ª—å –¥–∞–ª—å—à–µ 3–π –±—É–¥—É—â–µ–π - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –æ–ø–ª–∞—Ç—ã
    if (currentWeekOffset < 0 || currentWeekOffset > 3) {
        return;
    }

    const orderStatus = {{ order_status | tojson }};
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const mealTypes = ['breakfast', 'lunch'];

    days.forEach(day => {
        const daySection = document.getElementById('day-' + day);
        if (!daySection) return;

        mealTypes.forEach(mealType => {
            // –ö–ª—é—á —Ñ–æ—Ä–º–∞—Ç–∞: "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫_–∑–∞–≤—Ç—Ä–∞–∫_0"
            const key = `${day}_${mealType}_${currentWeekOffset}`;
            const status = orderStatus[key];

            if (status) {
                // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞
                const mealItems = daySection.querySelectorAll('.meal-item');
                mealItems.forEach(item => {
                    const mealHeader = item.querySelector('.meal-header');
                    if (!mealHeader) return;

                    const isBreakfast = mealHeader.textContent.includes('üïó –ó–∞–≤—Ç—Ä–∞–∫');
                    const isLunch = mealHeader.textContent.includes('üïê –û–±–µ–¥');
                    const mealMatch = (mealType === 'breakfast' && isBreakfast) ||
                                     (mealType === 'lunch' && isLunch);

                    if (mealMatch) {
                        const badge = item.querySelector('.status-badge');
                        if (badge) {
                            badge.style.display = 'inline-block';
                            if (status.consumed) {
                                badge.classList.add('status-consumed');
                                badge.textContent = '–ü–æ–ª—É—á–µ–Ω–æ';
                            } else if (status.paid) {
                                badge.classList.add('status-paid');
                                badge.textContent = '–û–ø–ª–∞—á–µ–Ω–æ';
                            }
                        }
                    }
                });
            }
        });
    });
}

// ========================================
// –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –î–ù–ï–ô –í –ú–ï–ù–Æ
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.tab-btn[data-day]').forEach(btn => {
        btn.addEventListener('click', function(e) {

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.day-section').forEach(d => d.classList.remove('active'));
            this.classList.add('active');

            const day = this.dataset.day;
            document.getElementById('day-' + day).classList.add('active');

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è –¥–ª—è —Å–µ–∫—Ü–∏–∏
            document.querySelectorAll('.day-section').forEach(sec => {
                sec.classList.remove('weekend-section');
            });

            if (day === 'saturday' || day === 'sunday') {
                document.getElementById('day-' + day).classList.add('weekend-section');
            }
        });
    });
});

// ========================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –¶–ï–ù –ü–†–ò –í–´–ë–û–†–ï –î–ù–Ø –ò –ü–†–ò–Å–ú–ê
// ========================================
const mealPrices = {{ meals | tojson }};
const daySelect = document.getElementById('pay-day-select');
const mealSelect = document.getElementById('pay-meal-select');

function updateMealOptions() {
    if (!daySelect || !mealSelect) return;

    const selectedDay = daySelect.value;
    const breakfastOpt = mealSelect.options[0];
    const lunchOpt = mealSelect.options[1];

    // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è
    const breakfastPrice = mealPrices[selectedDay]?.breakfast?.price || 0;
    const lunchPrice = mealPrices[selectedDay]?.lunch?.price || 0;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏ data-price
    breakfastOpt.textContent = `üïó –ó–∞–≤—Ç—Ä–∞–∫ (${breakfastPrice} ‚ÇΩ)`;
    breakfastOpt.dataset.price = breakfastPrice;
    lunchOpt.textContent = `üïê –û–±–µ–¥ (${lunchPrice} ‚ÇΩ)`;
    lunchOpt.dataset.price = lunchPrice;

    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ–ø–ª–∞—Ç—ã
    updatePayButton();
}

function updatePayButton() {
    if (!daySelect || !mealSelect) return;

    const day = daySelect.value;
    const meal = mealSelect.value;
    const key = day + '_' + meal;
    const paidMeals = {{ paid_keys_simple | tojson }};
    const isPaid = paidMeals.includes(key);

    const button = document.getElementById('single-pay-btn');
    if (button) {
        button.disabled = isPaid;
        button.textContent = isPaid ? '‚úÖ –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ' : 'üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Ä–∞–∑–æ–≤–æ';
    }
}

// ========================================
// –ó–ê–ì–†–£–ó–ö–ê –ê–í–ê–¢–ê–†–ö–ò
// ========================================
const avatarInput = document.getElementById('avatar-input');
const avatarFileInput = document.getElementById('avatar-file-input');
const avatarPreview = document.getElementById('avatar-preview');
const avatarForm = document.getElementById('avatar-upload-form');

if (avatarInput && avatarFileInput) {
    avatarInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            const reader = new FileReader();
            reader.onload = function(event) {
                avatarPreview.src = event.target.result;
            };
            reader.readAsDataURL(file);

            // –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ —Å–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
            avatarFileInput.files = e.target.files;
            avatarForm.submit();
        }
    });
}

// ========================================
// –°–û–ë–´–¢–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ========================================
if (daySelect) daySelect.addEventListener('change', updateMealOptions);
if (mealSelect) mealSelect.addEventListener('change', updatePayButton);

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π –º–µ–Ω—é
document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', function() {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–º—É
        this.classList.add('active');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–µ–∫—Ü–∏—é
        const sectionId = this.dataset.section;
        document.getElementById(sectionId).classList.add('active');
    });
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
updateWeekDropdown();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–µ–ª–∏
updateWeekDisplay();
</script>
{% endblock %}