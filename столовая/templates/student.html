<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ö–∞–±–∏–Ω–µ—Ç —É—á–µ–Ω–∏–∫–∞</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .layout {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
        }
        .menu-panel {
            flex: 2;
        }
        .preferences-panel {
            flex: 1;
        }
        .day-section {
            display: none;
        }
        .day-section.active {
            display: block;
        }
        .meal-item {
            margin-bottom: 20px;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fafafa;
        }
        .meal-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .status-badge {
            font-size: 0.85rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }
        .status-paid { background: #e8f5e9; color: #2e7d32; }
        .status-consumed { background: #fff8e1; color: #ff8f00; }
        .review-form { margin-top: 8px; }
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 8px 16px;
            background: #e0e0ff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .tab-btn.active {
            background: #4361ee;
            color: white;
        }
        .tab-btn.today-tab {
            background: #ffeaa7 !important;
            color: #d63031 !important;
            font-weight: bold;
        }
        .payment-card select {
            width: 100%;
            padding: 8px;
            margin: 6px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<header>
    <h1>üçΩÔ∏è –ö–∞–±–∏–Ω–µ—Ç —É—á–µ–Ω–∏–∫–∞</h1>
</header>

<div class="container">

    <!-- üì¢ FLASH-–°–û–û–ë–©–ï–ù–ò–Ø -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash-message flash-{{ category if category in ['success', 'error'] else 'info' }}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- üí∞ –ë–ê–õ–ê–ù–° -->
    <div class="card" style="background: #e8f5e9; border-left: 4px solid #2ecc71;">
        <h3>üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: <strong>{{ "%.2f"|format(current_balance) }} ‚ÇΩ</strong></h3>
    </div>

    <div class="layout">
        <div class="menu-panel">
            <h2>üìã –ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</h2>

            <div class="tabs" id="dayTabs">
                {% for day in days %}
                    <button class="tab-btn {% if loop.first %}active{% endif %} {% if day == current_day %}today-tab{% endif %}" data-day="{{ day }}">
                        {{ day_names[day] }}
                        {% if day == current_day %}<span style="color: #e74c3c;"> ‚Ä¢ –°–µ–≥–æ–¥–Ω—è</span>{% endif %}
                    </button>
                {% endfor %}
            </div>

            {% for day in days %}
            <div class="day-section {% if loop.first %}active{% endif %}" id="day-{{ day }}">
                {% for meal_type, meal in meals[day].items() %}
                    {% if meal %}
                    <div class="meal-item">
                        <div class="meal-header">
                            <span>
                                {{ "üïó –ó–∞–≤—Ç—Ä–∞–∫" if meal_type == "breakfast" else "üïê –û–±–µ–¥" }}
                                {% set key = (day, meal_type) %}
                                {% if order_status.get(key) %}
                                    {% if order_status[key].consumed %}
                                        <span class="status-badge status-consumed">–ü–æ–ª—É—á–µ–Ω–æ</span>
                                    {% elif order_status[key].paid %}
                                        <span class="status-badge status-paid">–û–ø–ª–∞—á–µ–Ω–æ</span>
                                    {% endif %}
                                {% endif %}
                            </span>
                            <span>{{ meal.price if meal else '‚Äî' }} ‚ÇΩ</span>
                        </div>
                        <p>{{ meal.name }}</p>

                        <!-- –û—Ç–∑—ã–≤ -->
                        <form method="post" action="/submit_review" class="review-form">
                            <input type="hidden" name="day" value="{{ day }}">
                            <input type="hidden" name="meal_type" value="{{ meal_type }}">
                            <textarea name="text" placeholder="–í–∞—à –æ—Ç–∑—ã–≤..." style="height: 60px;">{{ user_reviews.get((day, meal_type), '') }}</textarea>
                            <button type="submit" class="btn-review" style="width: auto; margin-top: 6px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </form>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <div class="preferences-panel">
            <div class="card">
                <h2>‚ö†Ô∏è –ü–∏—â–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</h2>
                <form method="post">
                    <textarea name="allergy" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∞–ª–ª–µ—Ä–≥–∏—è –Ω–∞ –º–æ–ª–æ–∫–æ, –±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞">{{ current_allergy }}</textarea>
                    <button type="submit" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="card">
        <h2>üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <p>–û–ø–ª–∞—á–µ–Ω–æ: <strong>{{ paid_count }}</strong> –∏–∑ {{ total_possible }}</p>
        <p>–ü–æ–ª—É—á–µ–Ω–æ: <strong>{{ consumed_count }}</strong> –∏–∑ {{ total_possible }}</p>
        <div style="background: #f0f0f0; padding: 10px; border-radius: 6px; margin-top: 10px;">
            –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å: <strong>{{ (consumed_count / total_possible * 100) | round }}%</strong>
        </div>
    </div>

    <!-- üí≥ –ü–û–ü–û–õ–ù–ï–ù–ò–ï –ö–û–®–ï–õ–¨–ö–ê -->
    <div class="card">
        <h2>üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</h2>
        <form method="post" action="/topup">
            <input type="number" name="amount" min="10" max="10000" step="10" placeholder="–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (‚ÇΩ)" required
                   style="margin-bottom: 10px;">
            <button type="submit" class="btn-save" style="background: #3498db;">‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        </form>
        <p style="font-size: 0.9rem; color: #666; margin-top: 8px;">
            ‚ö†Ô∏è –≠—Ç–æ –∏–º–∏—Ç–∞—Ü–∏—è. –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –ø–ª–∞—Ç—ë–∂–Ω—ã–π —à–ª—é–∑.
        </p>
    </div>

    <!-- –û–ø–ª–∞—Ç–∞ -->
    <div class="card payment-card">
        <h2>üí≥ –û–ø–ª–∞—Ç–∞ –ø–∏—Ç–∞–Ω–∏—è</h2>

        {% if not current_user.has_subscription %}
            <!-- –ê–±–æ–Ω–µ–º–µ–Ω—Ç —Å–æ —Å–∫–∏–¥–∫–æ–π -->
            <form method="post" action="/pay" style="margin: 10px 0;">
                <input type="hidden" name="type" value="subscription">
                <p><strong>–ê–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–∏—ë–º—ã</strong></p>
                <p>–ü–æ–ª–Ω–∞—è —Ü–µ–Ω–∞: {{ "%.2f"|format(full_subscription_price) }} ‚ÇΩ</p>
                <p>–£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ: {{ "%.2f"|format(paid_sum) }} ‚ÇΩ</p>
                <p><b>–ö –æ–ø–ª–∞—Ç–µ: {{ "%.2f"|format(remaining_subscription_price) }} ‚ÇΩ</b></p>
                <button type="submit" class="btn-pay">–û–ø–ª–∞—Ç–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç</button>
            </form>

            <!-- –†–∞–∑–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞ -->
            <form method="post" action="/pay" id="single-pay-form">
                <input type="hidden" name="type" value="single">
                <label>–î–µ–Ω—å:</label>
                <select name="day" required id="pay-day-select">
                    {% for day in days %}
                        {% set day_num = loop.index0 %}
                        {% if current_day %}
                            {% set today_num = days.index(current_day) %}
                            {% if day_num >= today_num %}
                                <option value="{{ day }}">{{ day_names[day] }}</option>
                            {% endif %}
                        {% else %}
                            <!-- –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–Ω–æ–π ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–Ω–∏ -->
                            <option value="{{ day }}">{{ day_names[day] }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <label>–ü—Ä–∏—ë–º –ø–∏—â–∏:</label>
                <select name="meal_type" required id="pay-meal-select">
                    <option value="breakfast" data-price="{{ meals['monday']['breakfast'].price if meals['monday']['breakfast'] else 0 }}">üïó –ó–∞–≤—Ç—Ä–∞–∫ ({{ meals['monday']['breakfast'].price if meals['monday']['breakfast'] else '0' }} ‚ÇΩ)</option>
                    <option value="lunch" data-price="{{ meals['monday']['lunch'].price if meals['monday']['lunch'] else 0 }}">üïê –û–±–µ–¥ ({{ meals['monday']['lunch'].price if meals['monday']['lunch'] else '0' }} ‚ÇΩ)</option>
                </select>
                <button type="submit" class="btn-save" style="background: #e67e22; width: 100%; margin-top: 10px;" id="single-pay-btn">
                    –û–ø–ª–∞—Ç–∏—Ç—å —Ä–∞–∑–æ–≤–æ
                </button>
            </form>

            <script>
                // –í—Å–µ —Ü–µ–Ω—ã –ø–æ –¥–Ω—è–º –∏ –ø—Ä–∏—ë–º–∞–º
                const mealPrices = {{ meals | tojson }};

                const daySelect = document.getElementById('pay-day-select');
                const mealSelect = document.getElementById('pay-meal-select');

                function updateMealOptions() {
                    const selectedDay = daySelect.value;
                    const breakfastOpt = mealSelect.options[0];
                    const lunchOpt = mealSelect.options[1];

                    // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è
                    const breakfastPrice = mealPrices[selectedDay]?.breakfast?.price || 0;
                    const lunchPrice = mealPrices[selectedDay]?.lunch?.price || 0;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏ data-price
                    breakfastOpt.textContent = `üïó –ó–∞–≤—Ç—Ä–∞–∫ (${breakfastPrice} ‚ÇΩ)`;
                    breakfastOpt.dataset.price = breakfastPrice;

                    lunchOpt.textContent = `üïê –û–±–µ–¥ (${lunchPrice} ‚ÇΩ)`;
                    lunchOpt.dataset.price = lunchPrice;

                    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ–ø–ª–∞—Ç—ã
                    updatePayButton();
                }

                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–∏—ë–º —É–∂–µ –æ–ø–ª–∞—á–µ–Ω
                function updatePayButton() {
                    const day = daySelect.value;
                    const meal = mealSelect.value;
                    const key = day + '_' + meal;
                    const paidMeals = {{ order_status.keys() | map('join', '_') | list | tojson }};
                    const isPaid = paidMeals.includes(key);
                    const button = document.getElementById('single-pay-btn');
                    button.disabled = isPaid;
                    button.textContent = isPaid ? '–£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ' : '–û–ø–ª–∞—Ç–∏—Ç—å —Ä–∞–∑–æ–≤–æ';
                }

                // –°–æ–±—ã—Ç–∏—è
                daySelect.addEventListener('change', updateMealOptions);
                mealSelect.addEventListener('change', updatePayButton);

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                updateMealOptions();
            </script>
        {% else %}
            <p style="color: #2ecc71; font-weight: bold;">‚úÖ –ê–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ –Ω–µ–¥–µ–ª—é —É–∂–µ –æ–ø–ª–∞—á–µ–Ω!</p>
        {% endif %}
    </div>

    <a href="/logout" class="logout-link">üö™ –í—ã–π—Ç–∏</a>
</div>

<script>
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.day-section').forEach(d => d.classList.remove('active'));

            btn.classList.add('active');
            const day = btn.dataset.day;
            document.getElementById('day-' + day).classList.add('active');
        });
    });
</script>

<script>
    // –í—Å–µ —Ü–µ–Ω—ã –ø–æ –¥–Ω—è–º –∏ –ø—Ä–∏—ë–º–∞–º
    const mealPrices = {{ meals | tojson }};
</script>

</body>
</html>