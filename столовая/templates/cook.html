<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ö–∞–±–∏–Ω–µ—Ç –ø–æ–≤–∞—Ä–∞</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .scroll-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 10px;
            background: #fafafa;
            margin-bottom: 24px;
        }
        .student-card {
            background: white;
            border: 1px solid #e0e0ff;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.92rem;
            display: block;
        }
        .student-header {
            font-weight: bold;
            color: #2b2d42;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }
        .allergy-badge {
            background: #ffebee;
            color: #c62828;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .section-title {
            font-size: 0.95rem;
            margin: 8px 0 4px;
            color: #4361ee;
            font-weight: 600;
        }
        .meal-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.9rem;
            align-items: center;
        }
        .meal-type { color: #2b2d42; }
        .meal-date { color: #666; font-size: 0.85rem; }
        .review-box {
            background: #e8f5e9;
            padding: 4px 6px;
            border-radius: 4px;
            margin-top: 4px;
            font-style: italic;
            font-size: 0.85rem;
            color: #2e7d32;
        }
        .no-data { color: #888; font-style: italic; font-size: 0.9rem; }

        /* –ö–Ω–æ–ø–∫–∞ –≤—ã–¥–∞—á–∏ */
        .mark-btn {
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 6px;
        }
        .mark-btn:hover {
            background: #3a56e4;
        }

        /* –ü–∞–Ω–µ–ª—å —É—á–µ–Ω–∏–∫–æ–≤ */
        #students-panel {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f9f9fb;
            border-radius: 12px;
            border: 1px solid #eee;
        }
        #toggle-students {
            background: #4361ee;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
        }
        #toggle-students:hover {
            background: #3a56e4;
        }

        /* –ü–æ–∏—Å–∫ */
        #search-students {
            width: 100%;
            padding: 8px 12px;
            margin: 10px 0 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .menu-link {
            display: inline-block;
            margin-bottom: 16px;
            padding: 8px 16px;
            background: #e0e0ff;
            color: #4361ee;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
        }
        .menu-link:hover {
            background: #d0d0ff;
        }
    </style>
</head>
<body>

<header>
    <h1>üë®‚Äçüç≥ –ö–∞–±–∏–Ω–µ—Ç –ø–æ–≤–∞—Ä–∞</h1>
</header>

<div class="container">

    <!-- Flash-—Å–æ–æ–±—â–µ–Ω–∏—è -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div style="
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            background: {% if category == 'error' %}#e74c3c
                      {% elif category == 'warning' %}#f39c12
                      {% else %}#2ecc71{% endif %};
          ">
            {{ message.replace('\n', '<br>')|safe }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é -->
    <div class="card">
        <h2>üçΩÔ∏è –ú–µ–Ω—é</h2>
        <a href="/cook/menu" class="menu-link">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</a>
    </div>

    <!-- –û—Å—Ç–∞—Ç–∫–∏ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å -->
    <div class="card">
        <h2>üì¶ –û—Å—Ç–∞—Ç–∫–∏ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å (–¥–ª—è {{ total_students }} —É—á–µ–Ω–∏–∫(–æ–≤))</h2>
        {% if need_and_stock %}
            <div class="scroll-container" style="max-height: 250px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: #f0f0ff;">
                            <th style="padding: 8px; text-align: left;">–ü—Ä–æ–¥—É–∫—Ç</th>
                            <th style="padding: 8px; text-align: right;">–ù—É–∂–Ω–æ</th>
                            <th style="padding: 8px; text-align: right;">–ï—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in need_and_stock %}
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px;">{{ item.name }}</td>
                            <td style="padding: 8px; text-align: right;">{{ "%.1f"|format(item.needed) }} {{ item.unit }}</td>
                            <td style="padding: 8px; text-align: right; color: {% if item.current >= item.needed %}#2ecc71{% else %}#e74c3c{% endif %};">
                                {{ "%.1f"|format(item.current) }} {{ item.unit }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="no-orders">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö –∏–ª–∏ —É—á–µ–Ω–∏–∫–∞—Ö.</p>
        {% endif %}
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É -->
    <div class="card">
        <h2>üõí –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É</h2>
        <form id="add-to-cart-form" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <select id="product-select" required style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>
                {% for ing in all_ingredients %}
                <option value="{{ ing.name }}" data-unit="{{ ing.default_unit }}">{{ ing.name }}</option>
                {% endfor %}
            </select>
            <input type="number" id="quantity-input" min="1" step="1" value="1"
                   style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;" required>
            <button type="submit" class="btn-submit" style="width: auto; padding: 8px 12px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
    </div>

    <!-- –ö–æ—Ä–∑–∏–Ω–∞ –∑–∞–∫—É–ø–æ–∫ -->
    <div class="card">
        <h2>üì¶ –ö–æ—Ä–∑–∏–Ω–∞ –∑–∞–∫—É–ø–æ–∫</h2>
        <div id="cart-items" style="min-height: 60px;">
            <p id="cart-empty" style="color: #888;">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.</p>
            <ul id="cart-list" style="list-style: none; padding: 0; margin: 0;"></ul>
        </div>
        <div style="margin-top: 12px; display: flex; gap: 10px;">
            <button id="send-cart" class="btn-submit" style="flex: 1;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—É</button>
            <button id="clear-cart" class="btn-save" style="flex: 1; background: #e74c3c;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ —É—á–µ–Ω–∏–∫–æ–≤ -->
    <button id="toggle-students">üë• –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤</button>

    <!-- –ü–∞–Ω–µ–ª—å —É—á–µ–Ω–∏–∫–æ–≤ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div id="students-panel">
        <input type="text" id="search-students" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û...">
        <div class="scroll-container" id="students-list">
            {% if students %}
                {% for item in students %}
                <div class="student-card" data-name="{{ item.student.full_name|lower }}">
                    <div class="student-header">
                        <span>{{ item.student.full_name }}</span>
                        {% if item.allergy %}
                            <span class="allergy-badge">‚ö†Ô∏è {{ item.allergy[:20] }}{% if item.allergy|length > 20 %}...{% endif %}</span>
                        {% endif %}
                    </div>

                    <div class="section-title">üïó –û–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏</div>
                    {% if item.pending %}
                        {% for order_entry in item.pending %}
                        <div class="meal-item">
                            <span class="meal-type">{{ "–ó–∞–≤—Ç—Ä–∞–∫" if order_entry.order.meal_type == "breakfast" else "–û–±–µ–¥" }}</span>
                            <span>
                                <span class="meal-date">{{ order_entry.order.serving_date.strftime('%d.%m') }}</span>
                                <form method="post" action="/cook/mark_collected" style="display: inline;">
                                    <input type="hidden" name="order_id" value="{{ order_entry.order.id }}">
                                    <button type="submit" class="mark-btn">–í—ã–¥–∞–Ω–æ</button>
                                </form>
                            </span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-data">‚Äî</p>
                    {% endif %}

                    <div class="section-title">‚úÖ –ü–æ–ª—É—á–µ–Ω–æ</div>
                    {% if item.completed %}
                        {% for order_entry in item.completed %}
                        <div class="meal-item">
                            <span class="meal-type">{{ "–ó–∞–≤—Ç—Ä–∞–∫" if order_entry.order.meal_type == "breakfast" else "–û–±–µ–¥" }}</span>
                            <span class="meal-date">{{ order_entry.order.serving_date.strftime('%d.%m') }}</span>
                        </div>
                        {% if order_entry.review %}
                        <div class="review-box">
                            "{{ order_entry.review.text[:40] }}{% if order_entry.review.text|length > 40 %}...{% endif %}"
                        </div>
                        {% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="no-data">‚Äî</p>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p class="no-orders">–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤.</p>
            {% endif %}
        </div>
    </div>

    <a href="/logout" class="logout-link">üö™ –í—ã–π—Ç–∏</a>
</div>

<script>
let cart = {};

function updateCartUI() {
    const list = document.getElementById('cart-list');
    const emptyMsg = document.getElementById('cart-empty');
    list.innerHTML = '';

    if (Object.keys(cart).length === 0) {
        emptyMsg.style.display = 'block';
        list.style.display = 'none';
    } else {
        emptyMsg.style.display = 'none';
        list.style.display = 'block';

        for (const [product, data] of Object.entries(cart)) {
            const li = document.createElement('li');
            li.style.padding = '8px 0';
            li.style.borderBottom = '1px solid #eee';
            li.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <strong>${product}</strong>
                    <input type="number" class="edit-qty" value="${data.quantity}"
                           data-product="${product}" min="1" style="width: 80px; padding: 4px;">
                    <span>${data.unit}</span>
                    <button type="button" class="remove-item" data-product="${product}"
                            style="color: #e74c3c; background: none; border: none; cursor: pointer;">‚úï</button>
                </div>
            `;
            list.appendChild(li);
        }

        document.querySelectorAll('.edit-qty').forEach(input => {
            input.addEventListener('change', () => {
                const qty = parseInt(input.value) || 1;
                cart[input.dataset.product].quantity = Math.max(1, qty);
            });
        });

        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', () => {
                delete cart[btn.dataset.product];
                updateCartUI();
            });
        });
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
document.getElementById('add-to-cart-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const select = document.getElementById('product-select');
    const qtyInput = document.getElementById('quantity-input');
    const product = select.value;
    const quantity = parseInt(qtyInput.value) || 1;
    const unit = select.options[select.selectedIndex]?.dataset.unit || '–≥';

    if (!product) return;

    if (cart[product]) {
        cart[product].quantity += quantity;
    } else {
        cart[product] = { quantity, unit };
    }
    updateCartUI();
    select.value = '';
    qtyInput.value = '1';
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
document.getElementById('send-cart').addEventListener('click', () => {
    if (Object.keys(cart).length === 0) {
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
        return;
    }

    const requestData = Object.entries(cart).map(([product, data]) => ({
        product: product,
        quantity: data.quantity,
        unit: data.unit
    }));

    fetch('/cook/submit_bulk_request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            cart = {};
            updateCartUI();
            alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.');
    });
});

// –û—á–∏—Å—Ç–∫–∞
document.getElementById('clear-cart').addEventListener('click', () => {
    cart = {};
    updateCartUI();
});

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —É—á–µ–Ω–∏–∫–æ–≤
document.getElementById('toggle-students').addEventListener('click', function() {
    const panel = document.getElementById('students-panel');
    if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        this.textContent = '–°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤';
    } else {
        panel.style.display = 'none';
        this.textContent = 'üë• –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤';
    }
});

// –ü–æ–∏—Å–∫
document.getElementById('search-students').addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    document.querySelectorAll('.student-card').forEach(card => {
        const name = card.dataset.name;
        card.style.display = (query === '' || name.includes(query)) ? 'block' : 'none';
    });
});

updateCartUI();
</script>

</body>
</html>